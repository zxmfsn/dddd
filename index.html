<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>å°æ‰‹æœº</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .phone-screen {
            max-width: 375px;
            height: 100vh;
            margin: 0 auto;
            position: relative;
            color: white;
        }
        
        /* ä¸»å±å¹•æ ·å¼ */
        .main-screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .user-info {
            text-align: center;
            padding: 60px 20px 40px;
            cursor: pointer;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-id {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .signature {
            font-size: 14px;
            opacity: 0.9;
            font-style: italic;
        }
        
        .apps-grid {
            padding: 0 30px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 40px;
        }
        
             .app-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
             .app-icon {
            width: 65px;
            height: 65px;
            border-radius: 18px;
            cursor: pointer;
            transition: transform 0.3s ease;
            overflow: hidden;
        }


        .app-icon:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.25);
        }
        
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-emoji {
            font-size: 24px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-emoji img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .app-name {
            font-size: 10px;
            text-align: center;
            opacity: 0.9;
            font-weight: 500;
        }

        
        .app-icon:hover {
            transform: scale(1.05);
            background: rgba(255,255,255,0.25);
        }
        
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .app-emoji {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .app-name {
            font-size: 10px;
            text-align: center;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .bottom-space {
            flex: 1;
        }
        
        /* å£çº¸é¡µé¢æ ·å¼ */
        .wallpaper-screen {
            height: 100vh;
            background: white;
            color: #333;
            display: none;
            flex-direction: column;
        }
        
        .wallpaper-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: background 0.3s;
        }
        
        .back-btn:hover {
            background: #e0e0e0;
        }
        
        .header-title {
            flex: 1;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            margin-right: 40px;
        }
        
        .wallpaper-content {
            flex: 1;
            padding: 30px 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }
        
        .wallpaper-editor {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .preview-area {
            flex-shrink: 0;
        }
        
        .preview-phone {
            width: 120px;
            height: 200px;
            border-radius: 20px;
            border: 3px solid #ddd;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .preview-phone img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-label {
            text-align: center;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        
        .input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .tab-buttons {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #f8f8f8;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-input-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .file-input-area:hover {
            border-color: #667eea;
        }
        
        .file-input-area input {
            display: none;
        }
        
      .url-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;  /* â† æ”¹æˆ16px */
    outline: none;
    transition: border-color 0.3s;
}
        
        .url-input:focus {
            border-color: #667eea;
        }
        
        .save-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            align-self: flex-start;
            margin-top: 10px;
        }
        
        .save-btn:hover {
            background: #5a6fd8;
        }
        
        .save-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 320px;
            max-width: 90%;
            color: #333;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 25px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input {
            width: 100%;
          max-width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            border-color: #667eea;
        }
        
        .avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f0f0f0;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid #e1e5e9;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-input {
            display: none;
        }
        
        .file-button {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .file-button:hover {
            background: #5a6fd8;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel {
            background: #f0f0f0;
            color: #666;
        }
        
        .btn-cancel:hover {
            background: #e0e0e0;
        }
        
        .btn-save {
            background: #667eea;
            color: white;
        }
        
        .btn-save:hover {
            background: #5a6fd8;
        }
/* ä¸–ç•Œä¹¦é¡µé¢æ ·å¼ */
.worldbook-screen {
    height: 100vh;
    background: white;
    color: #333;
    display: none;
    flex-direction: column;
}

.worldbook-header {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.category-bar {
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    overflow-x: auto;
    white-space: nowrap;
}

.category-tags {
    display: flex;
    gap: 10px;
}

.category-tag {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #ddd;
    background: #f8f8f8;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
    flex-shrink: 0;
}

.category-tag.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.worldbook-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.worldbook-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #eee;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
}

.card-preview {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
    line-height: 1.4;
}

.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-category {
    background: #f0f0f0;
    color: #666;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.card-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-edit {
    background: #667eea;
    color: white;
}

.btn-delete {
    background: #ff4757;
    color: white;
}

.add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: all 0.3s;
    z-index: 100;
}

.add-btn:hover {
    transform: scale(1.1);
}
/* APIè®¾ç½®é¡µé¢æ ·å¼ */
.api-screen {
    height: 100vh;
    background: white;
    color: #333;
    display: none;
    flex-direction: column;
}

.api-header {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.api-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.section {
    margin-bottom: 30px;
}

.scheme-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.scheme-btn {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f8f8;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.scheme-btn:hover {
    background: #e8e8e8;
}

.api-btn {
    width: 100%;
    padding: 12px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.3s;
}

.api-btn:hover {
    background: #5a6fd8;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.btn-test, .btn-save, .btn-save-scheme {
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-test {
    background: #48dbfb;
    color: white;
}

.btn-test:hover {
    background: #0abde3;
}

.btn-save {
    background: #1dd1a1;
    color: white;
}

.btn-save:hover {
    background: #10ac84;
}

.btn-save-scheme {
    background: #667eea;
    color: white;
}

.btn-save-scheme:hover {
    background: #5a6fd8;
}
/* èŠå¤©é¡µé¢æ ·å¼ */
.chat-screen {
    height: 100vh;
    background: white;
    color: #333;
    display: none;
    flex-direction: column;
}

.chat-header {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

/* æœ‹å‹åœˆå…¥å£å¡ç‰‡ */
.moments-card {
    margin: 15px 20px;
    padding: 16px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(102, 126, 234, 0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s;
}

.moments-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.moments-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.moments-icon {
    font-size: 24px;
}

.moments-text {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.moments-title {
    font-size: 15px;
    font-weight: 600;
    color: #667eea;
}

.moments-desc {
    font-size: 12px;
    color: #999;
}

.moments-arrow {
    font-size: 18px;
    color: #667eea;
}



/* èŠå¤©åˆ—è¡¨åŒºåŸŸ */
.chat-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px 20px 70px;
}
/* åº•éƒ¨åˆ†ç»„æ  */
.chat-bottom-tabs {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-width: 375px;
    margin: 0 auto;
    display: flex;
    background: white;
    border-top: 1px solid #eee;
    padding: 10px 0;
    z-index: 101;
}

.bottom-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
    background: transparent;
    border: none;
}

.bottom-tab.active {
    transform: scale(1.3);
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s ease;
    border: 1px solid #f0f0f0;
    position: relative; /* ç¡®ä¿è¿™ä¸€è¡Œå­˜åœ¨ */
    z-index: 2;
}


.chat-item:hover {
    background: #f8f8f8;
}

.chat-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
    margin-right: 12px;
}

.chat-info {
    flex: 1;
    min-width: 0;
}

.chat-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.chat-name {
    font-size: 15px;
    font-weight: 600;
    color: #333;
}

.chat-time {
    font-size: 11px;
    color: #999;
}

.chat-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-preview {
    font-size: 13px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
}

.chat-badge {
    background: #ff4757;
    color: white;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
}


.add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transition: all 0.3s;
    z-index: 100;
    display: none; /* é»˜è®¤éšè— */
}

.add-btn:hover {
    transform: scale(1.1);
}

/* åœ¨ä¸–ç•Œä¹¦å’ŒèŠå¤©é¡µé¢æ˜¾ç¤º */
.worldbook-screen .add-btn,
.chat-screen .add-btn {
    display: block;
}

  /* èŠå¤©é¡µé¢çš„æ·»åŠ æŒ‰é’®ä½ç½®ä¸Šç§» */
.chat-screen .add-btn {
    bottom: 90px; /* ä¸Šç§»é¿å¼€åº•éƒ¨æ  */
}
    /* æˆå‘˜é€‰æ‹©åˆ—è¡¨æ ·å¼ */
.member-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.3s;
}

.member-item:hover {
    background: #f8f8f8;
}

.member-item:last-child {
    border-bottom: none;
}

.member-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
}

.member-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 12px;
}

.member-name {
    font-size: 15px;
    color: #333;
}
/* å·¦æ»‘æ“ä½œç›¸å…³æ ·å¼ */
.chat-item-wrapper {
    position: relative;
    overflow: hidden;
    margin-bottom: 10px;
    border-radius: 12px; /* ä¿æŒåœ†è§’ */
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s ease; /* åªæœ‰transformæœ‰è¿‡æ¸¡ */
    border: 1px solid #f0f0f0;
    position: relative;
    z-index: 2;
}
.chat-item:hover {
    background: #f8f8f8;
}

.chat-actions {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    display: flex;
    z-index: 1;
    transform: translateX(100%); /* ç”¨transforméšè— */
    transition: transform 0.3s ease;
}
.action-btn-slide {
    width: 80px;
    border: none;
    color: white;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.action-pin {
    background: #667eea;
}

.action-pin:active {
    background: #5a6fd8;
}

.action-delete {
    background: #ff4757;
}

.action-delete:active {
    background: #ee5a6f;
}

.pin-badge {
    position: absolute;
    top: 0;
    right: 0;
    color: #667eea;
    font-size: 16px;
    z-index: 3;
    padding: 0px 0px;
 
    border-bottom-left-radius: 12px;
    border-top-right-radius: 12px;
}
/* èŠå¤©è¯¦æƒ…é¡µé¢æ ·å¼ */
.chat-detail-screen {
    height: 100vh;
    background: white;
    display: none;
    flex-direction: column;
}

.chat-detail-header {
    display: flex;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #eee;
}

.chat-detail-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    line-height: 1.2;
}

.character-status {
   font-size: 12px;  /* å…ˆè®¾ç½®ä¸€ä¸ªåŸºå‡†å¤§å° */
    transform: scale(0.9); /* å¼ºåˆ¶ç¼©å°åˆ° 85% (çº¦ç­‰äº 10px) */
    transform-origin: left top; /* â—ï¸å…³é”®ï¼šå›ºå®šå·¦ä¸Šè§’ç¼©æ”¾ï¼Œé˜²æ­¢ç¼©æ”¾åæ–‡å­—è·‘å */
    color: #999;
    font-style: italic;
    text-align: left;
    padding: 0;
    margin: 0;
    margin-top: 3px;
    background: transparent;
    line-height: 1.2;
}


.chat-name .status-tag {
    font-size: 11px;
    color: #667eea;
    font-weight: normal;
    margin-left: 6px;
}

/* æ¶ˆæ¯å®¹å™¨ */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f5f5f5;
}

.load-more-btn {
    width: 100%;
    padding: 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    color: #666;
    font-size: 13px;
    cursor: pointer;
    margin-bottom: 15px;
    transition: all 0.3s;
}

.load-more-btn:hover {
    background: #f8f8f8;
}

/* æ¶ˆæ¯æ°”æ³¡ */
.message-item {
    display: flex;
    margin-bottom: 15px;
    align-items: flex-end;
}

.message-item.me {
    flex-direction: row-reverse;
}

.message-bubble {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 12px;
    background: #e0e0e0;
    color: #333;
    word-wrap: break-word;
    line-height: 1.4;
}

.message-time {
    font-size: 11px;
    color: #999;
    margin: 0 8px;
    white-space: nowrap;
}

/* è¾“å…¥æ  */
.chat-input-bar {
    display: flex;
    align-items: flex-end;
    padding: 15px;
    border-top: 1px solid #eee;
    background: white;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    font-size: 16px;  /* â† æ”¹æˆ16px */
    resize: none;
    max-height: 72px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    outline: none;
    transition: border-color 0.3s;
    overflow: hidden;
    overflow-wrap: break-word;
}

/* éšè—textareaçš„æ‰€æœ‰ç®­å¤´å’Œæ»šåŠ¨æ¡æŒ‰é’® */
.chat-input::-webkit-scrollbar {
    width: 0px;
    height: 0px;
}

.chat-input::-webkit-scrollbar-button {
    display: none !important;
    height: 0;
    width: 0;
}

.chat-input::-webkit-scrollbar-thumb {
    background: transparent;
}

.chat-input::-webkit-scrollbar-track {
    background: transparent;
}

.chat-input::-webkit-inner-spin-button,
.chat-input::-webkit-outer-spin-button {
    -webkit-appearance: none !important;
    display: none !important;
    margin: 0;
}


.chat-input:focus {
    border-color: #667eea;
}
.chat-input:disabled {
    background: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.receive-btn {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.receive-btn:hover {
    background: #5a6fd8;
}

.receive-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* ç³»ç»Ÿæ¶ˆæ¯ */
.system-message {
    text-align: center;
    color: #999;
    font-size: 12px;
    margin: 10px 0;
}
/* ç¦ç”¨æ¶ˆæ¯æ–‡æœ¬é€‰æ‹© */
.message-bubble {
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
}

/* æ¶ˆæ¯æ“ä½œèœå•æŒ‰é’® */
.message-menu-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.3s;
    background: white;
    border: 1px solid #e0e0e0;
}

.message-menu-btn:hover {
    background: #f8f8f8;
}

.message-menu-btn:last-child {
    margin-bottom: 0;
}

/* æ’¤å›æ¶ˆæ¯æ ·å¼ */
.revoked-message {
    color: #999;
    font-style: italic;
    cursor: pointer;
    user-select: none;
}

.revoked-message:hover {
    text-decoration: underline;
}

.revoked-content {
    display: none;
    margin-top: 8px;
    padding: 8px;
    background: #f5f5f5;
    border-radius: 6px;
    font-size: 13px;
    color: #666;
}

.revoked-content.show {
    display: block;
}
/* å¤šé€‰æ¨¡å¼ç›¸å…³æ ·å¼ */
.message-item.multi-select-mode {
    padding-left: 50px;
    position: relative;
}

.message-checkbox {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.multi-select-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #eee;
}

.selected-count {
    font-size: 14px;
    color: #333;
}

.multi-select-actions {
    display: flex;
    gap: 10px;
}

.btn-multi-cancel {
    padding: 8px 20px;
    background: #f0f0f0;
    color: #666;
    border: none;
    border-radius: 16px;
    font-size: 14px;
    cursor: pointer;
}

.btn-multi-delete {
    padding: 8px 20px;
    background: #ff4757;
    color: white;
    border: none;
    border-radius: 16px;
    font-size: 14px;
    cursor: pointer;
}

/* å¼•ç”¨æ¡†æ ·å¼ */
.quote-box {
    padding: 12px 15px;
    background: #f5f5f5;
    border-left: 3px solid #667eea;
    margin: 0 15px;
}

.quote-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.quote-header span:first-child {
    font-size: 13px;
    color: #667eea;
    font-weight: 600;
}

.quote-close {
    font-size: 20px;
    color: #999;
    cursor: pointer;
    line-height: 1;
}

.quote-close:hover {
    color: #666;
}

.quote-content {
    font-size: 13px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* æ¶ˆæ¯ä¸­çš„å¼•ç”¨æ ·å¼ */
.message-quoted {
    background: rgba(102, 126, 234, 0.1);
    padding: 8px 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
}

.message-quoted-author {
    font-size: 12px;
    color: #667eea;
    font-weight: 600;
    margin-bottom: 4px;
}

.message-quoted-content {
    font-size: 12px;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.message-quoted-time {
    font-size: 11px;
    color: #999;
    margin-top: 2px;
}
/* è§’è‰²ä¿¡æ¯é¡µé¢ */
.character-info-screen {
    height: 100vh;
    background: white;
    display: none;
    flex-direction: column;
}

.character-info-content {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 30px;
}

.character-profile-section {
    text-align: center;
    padding: 30px 20px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
}

.character-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #e0e0e0;
    margin: 0 auto 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    cursor: pointer; /* æ–°å¢ */
    transition: transform 0.3s; /* æ–°å¢ */
    overflow: hidden; /* æ–°å¢ */
}
.character-avatar:hover {
    transform: scale(1.05);
}
.character-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.character-name {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
   cursor: pointer; /* æ–°å¢ */
}

.character-location {
    font-size: 14px;
    color: #666;
    margin-bottom: 25px;
    cursor: pointer; /* æ–°å¢ */
}
.character-location:hover {
    color: #667eea;
}
.character-stats {
    display: flex;
    justify-content: space-around;
    max-width: 300px;
    margin: 0 auto;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 20px;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 13px;
    color: #999;
}

.character-edit-form {
    padding: 20px;
}

/* é˜²æ­¢æ—¥æœŸé€‰æ‹©å™¨è¶…å‡ºå®¹å™¨ */
.character-edit-form input[type="date"] {
    max-width: 100%;
    box-sizing: border-box;
    -webkit-appearance: none;
    appearance: none;
}


.gender-options {
    display: flex;
    gap: 15px;
}

.gender-option {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #666;
    cursor: pointer;
}

.gender-option input {
    cursor: pointer;
}

.save-character-btn {
    width: 100%;
    padding: 14px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    cursor: pointer;
    margin-top: 20px;
    transition: background 0.3s;
}

.save-character-btn:hover {
    background: #5a6fd8;
}

.app-icon-editor {
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s;
}

.app-icon-editor:hover {
    transform: scale(1.05);
}

.app-icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    margin: 0 auto;
    overflow: hidden;
}

.app-icon-preview img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
/* æ—¥è®°é¡µé¢æ ·å¼ */
.diary-screen {
    height: 100vh;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
}

/* å¬å”¤å¡ç‰‡ */
.summon-card {
    margin: 20px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    text-align: center;
    color: white;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
}

.summon-card:active {
    transform: scale(0.98);
}

.summon-text {
    font-size: 16px;
    font-weight: 500;
}

/* æ˜Ÿæ˜Ÿç‰¹æ•ˆå®¹å™¨ */
.stars-container {
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    pointer-events: none;
}

.star {
    position: absolute;
    font-size: 20px;
    animation: starTwinkle 0.6s ease-out forwards;
    opacity: 0;
}

@keyframes starTwinkle {
    0% {
        opacity: 0;
        transform: translate(0, 0) scale(0) rotate(0deg);
    }
    50% {
        opacity: 1;
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg);
    }
}

/* å†™æ—¥è®°çŠ¶æ€å¡ç‰‡ */
.writing-diary-card {
    margin: 20px;
    padding: 30px 20px;
    background: white;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.writing-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin: 0 auto 15px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
}

.writing-text {
    font-size: 15px;
    color: #666;
    margin-bottom: 15px;
}

.pen-animation {
    font-size: 24px;
    animation: penWrite 1.5s ease-in-out infinite;
}

@keyframes penWrite {
    0%, 100% { transform: translateY(0) rotate(-10deg); }
    50% { transform: translateY(-5px) rotate(10deg); }
}

/* æ—¥è®°åˆ—è¡¨å®¹å™¨ */
.diary-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 0 0 20px;
}

/* æ—¥è®°å¡ç‰‡ */
.diary-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin: 15px 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s;
}

.diary-card:active {
    transform: scale(0.98);
}

.diary-title {
    font-size: 17px;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.diary-time {
    font-size: 12px;
    color: #999;
    margin-bottom: 10px;
}

.diary-preview {
    font-size: 14px;
    color: #666;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.diary-tags {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.diary-tag {
    background: #f0f0ff;
    color: #667eea;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
}

/* æ—¥è®°è¯¦æƒ…é¡µ */
.diary-detail-screen {
    height: 100vh;
    background: white;
    display: none;
    flex-direction: column;
}

.diary-detail-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.diary-detail-title {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    text-align: center;
    margin-bottom: 20px;
}

.diary-meta {
    text-align: center;
    font-size: 13px;
    color: #999;
    margin-bottom: 20px;
}

.diary-section {
    margin-bottom: 25px;
}

.diary-section-title {
    font-size: 15px;
    font-weight: 600;
    color: #667eea;
    margin-bottom: 10px;
}

.diary-section-content {
    font-size: 14px;
    color: #666;
    line-height: 1.8;
}

.diary-section-content li {
    margin-bottom: 8px;
}

.diary-reflection {
    font-size: 14px;
    color: #666;
    line-height: 2;
    text-indent: 2em;
    white-space: pre-wrap;
}

.strikethrough {
    text-decoration: line-through;
    text-decoration-color: #666;
    text-decoration-thickness: 1.5px;
    opacity: 0.6;
}

.checkbox-done {
    color: #1dd1a1;
}

.checkbox-undone {
    color: #ddd;
}


      
    </style>
</head>
<body>
    <div class="phone-screen">
        <!-- ä¸»å±å¹• -->
        <div class="main-screen" id="mainScreen">
            <div class="user-info" onclick="openEditModal()">
                <div class="avatar" id="mainAvatar">ğŸ‘¤</div>
                <div class="user-id" id="mainUserId">æˆ‘çš„å°æ‰‹æœº</div>
                <div class="signature" id="mainSignature">ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå‘€ï½</div>
            </div>
            
               <div class="apps-grid">
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('world')">
                        <div class="app-emoji" id="icon-world">ğŸŒ</div>
                    </div>
                    <div class="app-name">ä¸–ç•Œä¹¦</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('chat')">
                        <div class="app-emoji" id="icon-chat">ğŸ’¬</div>
                    </div>
                    <div class="app-name">èŠå¤©</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('wallpaper')">
                        <div class="app-emoji" id="icon-wallpaper">ğŸ¨</div>
                    </div>
                    <div class="app-name">å£çº¸</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('api')">
                        <div class="app-emoji" id="icon-api">âš™ï¸</div>
                    </div>
                    <div class="app-name">APIè®¾ç½®</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('placeholder1')">
                        <div class="app-emoji" id="icon-placeholder1">ğŸ“±</div>
                    </div>
                    <div class="app-name">åº”ç”¨1</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('placeholder2')">
                        <div class="app-emoji" id="icon-placeholder2">ğŸµ</div>
                    </div>
                    <div class="app-name">åº”ç”¨2</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('placeholder3')">
                        <div class="app-emoji" id="icon-placeholder3">ğŸ“·</div>
                    </div>
                    <div class="app-name">åº”ç”¨3</div>
                </div>
                <div class="app-icon-wrapper">
                    <div class="app-icon" onclick="openApp('placeholder4')">
                        <div class="app-emoji" id="icon-placeholder4">ğŸ®</div>
                    </div>
                    <div class="app-name">åº”ç”¨4</div>
                </div>
            </div>

            
            <div class="bottom-space"></div>
        </div>

        <!-- å£çº¸è®¾ç½®é¡µé¢ -->
        <div class="wallpaper-screen" id="wallpaperScreen">
            <div class="wallpaper-header">
                <button class="back-btn" onclick="backToMain()">â†</button>
                <div class="header-title">å£çº¸è®¾ç½®</div>
            </div>
            
            <div class="wallpaper-content">
                <div class="section-title">æ›´æ¢å£çº¸</div>
                
                <div class="wallpaper-editor">
                    <div class="preview-area">
                        <div class="preview-phone" id="wallpaperPreview">
                        </div>
                        <div class="preview-label">é¢„è§ˆæ•ˆæœ</div>
                    </div>
                    
                    <div class="input-area">
                        <div class="tab-buttons">
                            <button class="tab-btn active" onclick="switchTab('local')">æœ¬åœ°ç›¸å†Œ</button>
                            <button class="tab-btn" onclick="switchTab('url')">ç½‘å€é“¾æ¥</button>
                        </div>
                        
                        <div class="tab-content active" id="localTab">
                            <div class="file-input-area" onclick="document.getElementById('wallpaperFile').click()">
                                <div>ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                                <input type="file" id="wallpaperFile" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="tab-content" id="urlTab">
                            <input type="url" class="url-input" id="wallpaperUrl" placeholder="è¾“å…¥å›¾ç‰‡ç½‘å€...">
                        </div>
                        
                        <button class="save-btn" onclick="saveWallpaper()">ä¿å­˜å£çº¸</button>
                    </div>
                </div>
            
               <div class="section-title" style="margin-top: 40px;">æ›´æ¢appå›¾æ ‡</div>
                <div style="text-align: center; color: #666; font-size: 13px; margin-bottom: 20px;">
                    ç‚¹å‡»å›¾æ ‡è¿›è¡Œä¿®æ”¹
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 280px; margin: 0 auto;">
                    <div class="app-icon-editor" onclick="openIconEditor('world')">
                        <div class="app-icon-preview" id="preview-world">ğŸŒ</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">ä¸–ç•Œä¹¦</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('chat')">
                        <div class="app-icon-preview" id="preview-chat">ğŸ’¬</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">èŠå¤©</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('wallpaper')">
                        <div class="app-icon-preview" id="preview-wallpaper">ğŸ¨</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">å£çº¸</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('api')">
                        <div class="app-icon-preview" id="preview-api">âš™ï¸</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">APIè®¾ç½®</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('placeholder1')">
                        <div class="app-icon-preview" id="preview-placeholder1">ğŸ“±</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">åº”ç”¨1</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('placeholder2')">
                        <div class="app-icon-preview" id="preview-placeholder2">ğŸµ</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">åº”ç”¨2</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('placeholder3')">
                        <div class="app-icon-preview" id="preview-placeholder3">ğŸ“·</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">åº”ç”¨3</div>
                    </div>
                    <div class="app-icon-editor" onclick="openIconEditor('placeholder4')">
                        <div class="app-icon-preview" id="preview-placeholder4">ğŸ®</div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">åº”ç”¨4</div>
                    </div>
                </div>
</div>
                       
        </div>
      <!-- ä¸–ç•Œä¹¦é¡µé¢ -->
<div class="worldbook-screen" id="worldbookScreen">
    <div class="worldbook-header">
        <button class="back-btn" onclick="backToMain()">â†</button>
        <div class="header-title">ä¸–ç•Œä¹¦</div>
    </div>
    
    <div class="category-bar">
        <div class="category-tags" id="categoryTags">
            <div class="category-tag active" data-category="all">å…¨éƒ¨</div>
            <div class="category-tag" data-category="manage">ç®¡ç†åˆ†ç±»</div>
        </div>
    </div>
    
    <div class="worldbook-content" id="worldbookList">
        <!-- ä¸–ç•Œä¹¦åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <button class="add-btn" onclick="openAddWorldbook()">+</button>
</div>
      <!-- APIè®¾ç½®é¡µé¢ -->
<div class="api-screen" id="apiScreen">
    <div class="api-header">
        <button class="back-btn" onclick="backToMain()">â†</button>
        <div class="header-title">APIè®¾ç½®</div>
    </div>
    
    <div class="api-content">
        <!-- æ–¹æ¡ˆé€‰æ‹©åŒºåŸŸ -->
        <div class="section">
            <div class="section-title">å½“å‰æ–¹æ¡ˆ</div>
            <select id="apiSchemeSelect" class="form-input">
                <option value="">é€‰æ‹©æ–¹æ¡ˆ</option>
            </select>
            <div class="scheme-buttons">
                <button class="scheme-btn" onclick="newScheme()">æ–°å»º</button>
                <button class="scheme-btn" onclick="deleteScheme()">åˆ é™¤</button>
            </div>
        </div>
        
        <!-- APIé…ç½®åŒºåŸŸ -->
        <div class="section">
            <div class="section-title">APIé…ç½®</div>
            <div class="form-group">
                <label class="form-label">æ–¹æ¡ˆåç§°</label>
                <input type="text" id="apiName" class="form-input" placeholder="è¾“å…¥æ–¹æ¡ˆåç§°">
            </div>
            <div class="form-group">
                <label class="form-label">åä»£åœ°å€</label>
                <input type="url" id="apiBaseUrl" class="form-input" placeholder="https://api.openai.com/v1">
            </div>
            <div class="form-group">
                <label class="form-label">APIå¯†é’¥</label>
                <input type="password" id="apiKey" class="form-input" placeholder="sk-...">
            </div>
            <button class="api-btn" onclick="getModels()">è·å–æ¨¡å‹</button>
            
            <div class="form-group" id="modelGroup" style="display: none;">
                <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
                <select id="modelSelect" class="form-input">
                </select>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button class="btn-test" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="btn-save" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            <button class="btn-save-scheme" onclick="saveAsScheme()">ä¿å­˜ä¸ºæ–¹æ¡ˆ</button>
        </div>
    </div>
</div>
      <!-- èŠå¤©é¡µé¢ -->
<!-- èŠå¤©é¡µé¢ -->
<div class="chat-screen" id="chatScreen">
    <div class="chat-header">
        <button class="back-btn" onclick="backToMain()">â†</button>
        <div class="header-title">èŠå¤©</div>
    </div>
    
    <!-- æœ‹å‹åœˆå…¥å£å¡ç‰‡ -->
    <div class="moments-card" onclick="openMoments()">
        <div class="moments-left">
            <div class="moments-icon">ğŸŒŸ</div>
            <div class="moments-text">
                <div class="moments-title">æœ‹å‹åœˆ</div>
                <div class="moments-desc">çœ‹çœ‹å¤§å®¶åœ¨å¹²ä»€ä¹ˆ~</div>
            </div>
        </div>
        <div class="moments-arrow">â†’</div>
    </div>
    
    <!-- èŠå¤©åˆ—è¡¨ -->
    <div class="chat-list-container" id="chatListContainer">
        <!-- èŠå¤©åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
 <button class="add-btn" onclick="openAddChatMenu()">+</button>
    
    <!-- åº•éƒ¨åˆ†ç»„æ  -->
    <div class="chat-bottom-tabs">
        <button class="bottom-tab active" data-tab="single" onclick="switchChatTab('single')">ğŸ’¬</button>
        <button class="bottom-tab" data-tab="group" onclick="switchChatTab('group')">ğŸ‘¥</button>
        <button class="bottom-tab" data-tab="peek" onclick="switchChatTab('peek')">ğŸ‘€</button>
    </div>
</div>
<!-- èŠå¤©è¯¦æƒ…é¡µé¢ -->
<div class="chat-detail-screen" id="chatDetailScreen">
 <div class="chat-detail-header">
    <button class="back-btn" onclick="backToChatList()">â†</button>
    <div style="flex: 1; display: flex; flex-direction: column; margin-left: 10px;">
        <div class="chat-detail-title" id="chatDetailTitle">å¼ ä¸‰</div>
        <div class="character-status" id="characterStatus" style="display: none;"></div>
    </div>
    <button class="back-btn" onclick="openCharacterInfo()">â‹®</button>
</div>


     
   

    <div class="messages-container" id="messagesContainer">
        <button class="load-more-btn" id="loadMoreBtn" style="display: none;" onclick="loadMoreMessages()">
            ç‚¹å‡»æŸ¥çœ‹å†å²æ¶ˆæ¯
        </button>
        <div id="messagesList"></div>
    </div>
    <!-- å¼•ç”¨æ¶ˆæ¯æ¡† -->
<div class="quote-box" id="quoteBox" style="display: none;">
    <div class="quote-header">
        <span id="quoteAuthor">å¼•ç”¨ï¼šå¼ ä¸‰</span>
        <span class="quote-close" onclick="cancelQuote()">Ã—</span>
    </div>
    <div class="quote-content" id="quoteContent">æ¶ˆæ¯å†…å®¹...</div>
</div>

<!-- å¤šé€‰æ¨¡å¼æ“ä½œæ  -->
<div class="multi-select-bar" id="multiSelectBar" style="display: none;">
    <div class="selected-count">å·²é€‰<span id="selectedCountText">0</span>æ¡</div>
    <div class="multi-select-actions">
        <button class="btn-multi-cancel" onclick="cancelMultiSelect()">å–æ¶ˆ</button>
        <button class="btn-multi-delete" onclick="deleteSelectedMessages()">åˆ é™¤</button>
    </div>
</div>

    <div class="chat-input-bar">
        <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <button class="receive-btn" id="receiveBtn" onclick="receiveAIReply()">æ¥æ”¶</button>
    </div>
</div>
<!-- è§’è‰²ä¿¡æ¯é¡µé¢ -->
<div class="character-info-screen" id="characterInfoScreen">
    <div class="chat-detail-header">
        <button class="back-btn" onclick="backToDetail()">â†</button>
        <div class="chat-detail-title">è§’è‰²ä¿¡æ¯</div>
        <button class="back-btn" style="margin-left: auto; opacity: 0; pointer-events: none;">â‹®</button>
    </div>
    
    <div class="character-info-content">
   <!-- å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
<div class="character-profile-section">
    <div class="character-avatar" id="charAvatar" onclick="openEditBasicInfo()">ğŸ‘¤</div>
    <div class="character-name" id="charDisplayName" onclick="openEditBasicInfo()">è§’è‰²åå­—</div>
    <div class="character-location" id="charLocation" onclick="openEditBasicInfo()">ğŸ“ æœªè®¾ç½®åœ°å€</div>
    
    <div class="character-stats">
    <div class="stat-item" onclick="openDiaryList()" style="cursor: pointer;">
    <div class="stat-number" id="charFollowers">0</div>
    <div class="stat-label">æ—¥è®°</div>
</div>

        <div class="stat-item">
            <div class="stat-number" id="charFollowing">0</div>
            <div class="stat-label">å…³æ³¨ä¸­</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="charItinerary">0</div>
            <div class="stat-label">åŠ¨æ€</div>
        </div>
    </div>
</div>

        
        <!-- ç¼–è¾‘è¡¨å• -->
        <div class="character-edit-form">
          <div class="form-group">
    <label class="form-label">å¤‡æ³¨</label>
    <input type="text" id="charRemark" class="form-input" placeholder="è¾“å…¥å¤‡æ³¨åç§°">
</div>
            
            <div class="form-group">
                <label class="form-label">ç”Ÿæ—¥</label>
                <input type="date" id="charBirthday" class="form-input">
            </div>
            
    <div class="form-group">
    <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
        <span>æ˜¯å¦è®¾ç½®åŸå¸‚ä¿¡æ¯</span>
        <input type="checkbox" id="cityInfoCheckbox" style="width: 20px; height: 20px; cursor: pointer; margin: 0;" onclick="handleCityInfoCheckbox()">
    </label>
</div>


            
       <div class="form-group">
    <label class="form-label">è§’è‰²äººè®¾</label>
    <textarea id="charPersonality" class="form-input" rows="6" placeholder="è¾“å…¥è§’è‰²äººè®¾æè¿°...&#10;ä¾‹å¦‚ï¼šæ€§æ ¼å¼€æœ—æ´»æ³¼ï¼Œå–œæ¬¢è¿åŠ¨ï¼Œæ“…é•¿ç¤¾äº¤..."></textarea>
</div>
<div class="form-group">
    <label class="form-label">æˆ‘çš„äººè®¾</label>
    <textarea id="myPersonality" class="form-input" rows="6" placeholder="è¾“å…¥ä½ è‡ªå·±çš„äººè®¾...&#10;ä¾‹å¦‚ï¼šæˆ‘æ˜¯å¥½äºº..."></textarea>
</div>
<div class="form-group">
    <label class="form-label">å…³è”ä¸–ç•Œä¹¦</label>
    <div id="worldbookSelector" style="max-height: 200px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px; padding: 10px;">
        <!-- ä¸–ç•Œä¹¦åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>
<div class="form-group">
    <label class="form-label">ä¸Šä¸‹æ–‡å‚è€ƒ</label>
    <div style="display: flex; align-items: center; gap: 15px;">
        <input 
            type="range" 
            id="contextRoundsSlider" 
            min="0" 
            max="300" 
            value="30" 
            style="flex: 1; cursor: pointer;"
        >
        <input 
            type="number" 
            id="contextRoundsInput" 
            min="0" 
            max="300" 
            value="30" 
            style="width: 80px; padding: 8px; border: 2px solid #e1e5e9; border-radius: 8px; text-align: center; font-size: 16px;"
        >
        <span style="color: #666; font-size: 14px; white-space: nowrap;">è½®</span>
    </div>
    <div style="font-size: 12px; color: #999; margin-top: 5px;">
        1è½® = ä½ å‘1æ¬¡ + AIå›1æ¬¡ï¼Œå½“å‰å¯è®°å¿†æœ€è¿‘ <span id="contextMessagesCount">60</span> æ¡æ¶ˆæ¯
    </div>
</div>
<div class="form-group">
    <label class="form-label">å¯¼å‡ºèŠå¤©è®°å½•</label>
    <button class="api-btn" onclick="exportChatHistory()">å¯¼å‡ºä¸ºTXTæ–‡ä»¶</button>
    <div style="font-size: 12px; color: #999; margin-top: 5px;">
        å¯¼å‡ºä¸è¯¥è§’è‰²çš„æ‰€æœ‰æ–‡æœ¬èŠå¤©è®°å½•
    </div>
</div>
<div class="form-group">
    <label class="form-label">æ¸…é™¤èŠå¤©è®°å½•</label>
    <button class="api-btn" onclick="clearChatHistory()" style="background: #ff4757;">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
    <div style="font-size: 12px; color: #ff4757; margin-top: 5px;">
         æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤ä¸è¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•æ¢å¤
    </div>
</div>


      
            <button class="save-character-btn" onclick="saveCharacterInfo()">ä¿å­˜è§’è‰²ä¿¡æ¯</button>
        </div>
    </div>
</div>
<!-- æ—¥è®°åˆ—è¡¨é¡µé¢ -->
<div class="diary-screen" id="diaryScreen">
    <div class="chat-detail-header">
        <button class="back-btn" onclick="backToCharacterInfo()">â†</button>
        <div class="chat-detail-title" id="diaryOwnerName">æ—¥è®°</div>
        <button class="back-btn" style="opacity: 0; pointer-events: none;">â‹®</button>
    </div>
    
    <!-- å¬å”¤å¡ç‰‡ -->
    <div class="summon-card" id="summonCard" onclick="summonDiary()">
        <div class="summon-text">ğŸ’Œ å¿«æ¥å–ŠTAå†™æ—¥è®°å§~</div>
        <div class="stars-container" id="starsContainer"></div>
    </div>
    
    <!-- å†™æ—¥è®°çŠ¶æ€ -->
    <div class="writing-diary-card" id="writingCard" style="display: none;">
        <div class="writing-avatar" id="writingAvatar">ğŸ‘¤</div>
        <div class="writing-text">
            <span id="writerName">å¼ ä¸‰</span>æ­£åœ¨å†™æ—¥è®°...
        </div>
        <div class="pen-animation">âœï¸</div>
    </div>
    
    <!-- æ—¥è®°åˆ—è¡¨ -->
    <div class="diary-list-container" id="diaryListContainer">
        <!-- æ—¥è®°å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<!-- æ—¥è®°è¯¦æƒ…é¡µ -->
<div class="diary-detail-screen" id="diaryDetailScreen">
    <div class="chat-detail-header">
        <button class="back-btn" onclick="backToDiaryList()">â†</button>
        <div class="chat-detail-title">æ—¥è®°è¯¦æƒ…</div>
        <button class="back-btn" onclick="deleteDiary()" style="color: #ff4757;">åˆ é™¤</button>
    </div>
    
    <div class="diary-detail-content" id="diaryDetailContent">
        <!-- æ—¥è®°è¯¦ç»†å†…å®¹å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
    </div>
</div>


    </div>

    <!-- ç¼–è¾‘å¼¹çª— -->
    <div class="modal-overlay" id="editModal" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-title">ç¼–è¾‘ä¸ªäººä¿¡æ¯</div>
            
            <div class="form-group">
                <label class="form-label">å¤´åƒ</label>
                <div class="avatar-preview" id="avatarPreview">ğŸ‘¤</div>
                <label for="avatarInput" class="file-button">é€‰æ‹©å¤´åƒ</label>
                <input type="file" id="avatarInput" class="file-input" accept="image/*">
            </div>
            
            <div class="form-group">
                <label class="form-label">IDåç§°</label>
                <input type="text" id="userIdInput" class="form-input" placeholder="è¾“å…¥ä½ çš„ID">
            </div>
            
            <div class="form-group">
                <label class="form-label">ä¸ªæ€§ç­¾å</label>
                <input type="text" id="signatureInput" class="form-input" placeholder="è¾“å…¥ä¸ªæ€§ç­¾å">
            </div>
                                <div class="form-group">
                <label class="form-label">å­—ä½“é¢œè‰²</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="textColorInput" class="form-input" value="#ffffff" style="flex: 1;">
                    <div id="textColorPreview" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid #e1e5e9; background: #ffffff;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Appå›¾æ ‡å­—ä½“é¢œè‰²</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="appTextColorInput" class="form-input" value="#ffffff" style="flex: 1;">
                    <div id="appTextColorPreview" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid #e1e5e9; background: #ffffff;"></div>
                </div>
            </div>

<div style="text-align: center; font-size: 11px; color: #999; margin-top: 15px; padding: 10px; background: #f9f9f9; border-radius: 6px;">
    å¤©æ°”æ•°æ®ç”± <a href="https://openweathermap.org" target="_blank" style="color: #667eea; text-decoration: none;">OpenWeatherMap</a> æä¾›
</div>

            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-save" onclick="saveUserInfo()">ä¿å­˜</button>
            </div>
        </div>
    </div>
<!-- ä¸–ç•Œä¹¦ç¼–è¾‘å¼¹çª— -->
<div class="modal-overlay" id="worldbookModal" onclick="closeWorldbookModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title" id="worldbookModalTitle">æ·»åŠ ä¸–ç•Œä¹¦</div>
        
        <div class="form-group">
            <label class="form-label">æ ‡é¢˜</label>
            <input type="text" id="worldbookTitle" class="form-input" placeholder="è¾“å…¥ä¸–ç•Œä¹¦æ ‡é¢˜">
        </div>
        
        <div class="form-group">
            <label class="form-label">åˆ†ç±»</label>
            <select id="worldbookCategory" class="form-input">
                <option value="é»˜è®¤åˆ†ç±»">é»˜è®¤åˆ†ç±»</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">å†…å®¹</label>
            <textarea id="worldbookContent" class="form-input" rows="6" placeholder="è¾“å…¥ä¸–ç•Œä¹¦å†…å®¹..."></textarea>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeWorldbookModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveWorldbook()">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- åˆ†ç±»ç®¡ç†å¼¹çª— -->
<div class="modal-overlay" id="categoryModal" onclick="closeCategoryModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">ç®¡ç†åˆ†ç±»</div>
        
        <div class="form-group">
            <label class="form-label">æ·»åŠ æ–°åˆ†ç±»</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="newCategoryName" class="form-input" placeholder="è¾“å…¥åˆ†ç±»åç§°" style="flex: 1;">
                <button class="btn btn-save" onclick="addCategory()" style="flex: none; padding: 12px 16px;">æ·»åŠ </button>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">ç°æœ‰åˆ†ç±»</label>
            <div id="categoryList" style="max-height: 200px; overflow-y: auto;">
                <!-- åˆ†ç±»åˆ—è¡¨å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeCategoryModal()">å…³é—­</button>
        </div>
    </div>
</div>
<!-- æ·»åŠ å•èŠå¼¹çª— -->
<div class="modal-overlay" id="addSingleChatModal" onclick="closeAddSingleModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">æ·»åŠ å•èŠ</div>
        
        <div class="form-group">
            <label class="form-label">è§’è‰²åå­—</label>
            <input type="text" id="singleChatName" class="form-input" placeholder="è¾“å…¥è§’è‰²åå­—">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeAddSingleModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="createSingleChat()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- é€‰æ‹©æˆå‘˜å¼¹çª— -->
<div class="modal-overlay" id="selectMembersModal" onclick="closeSelectMembersModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 320px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div class="modal-title" style="margin: 0;">é€‰æ‹©æˆå‘˜</div>
            <button class="btn btn-save" onclick="confirmMemberSelection()" style="padding: 8px 16px; margin: 0;">ç¡®å®š</button>
        </div>
        
        <div style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 14px; color: #666;">
            å·²é€‰ï¼š<span id="selectedCount">0</span>äºº
        </div>
        
        <div id="membersList" style="max-height: 300px; overflow-y: auto;">
            <!-- æˆå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>
  <!-- æ¶ˆæ¯æ“ä½œèœå•å¼¹çª— -->
<div class="modal-overlay" id="messageMenuModal" onclick="closeMessageMenu(event)">
    <div class="modal" onclick="event.stopPropagation()" style="padding: 20px; width: 280px;">
        <div class="modal-title" style="margin-bottom: 20px;">é€‰æ‹©æ“ä½œ</div>
        
       <button class="message-menu-btn" id="deleteMessageBtn" onclick="startMultiSelectMode()">
    åˆ é™¤
</button>
<button class="message-menu-btn" id="quoteMessageBtn" onclick="quoteSelectedMessage()">
    å¼•ç”¨
</button>
<button class="message-menu-btn" id="revokeMessageBtn" onclick="revokeSelectedMessage()">
    æ’¤å›
</button>
<button class="message-menu-btn" onclick="closeMessageMenu()" style="background: #f0f0f0; color: #666;">
    å–æ¶ˆ
</button>

    </div>
</div>
<!-- åŸºæœ¬ä¿¡æ¯ç¼–è¾‘å¼¹çª— -->
<div class="modal-overlay" id="editBasicInfoModal" onclick="closeEditBasicInfo(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">ç¼–è¾‘åŸºæœ¬ä¿¡æ¯</div>
        
        <div class="form-group">
            <label class="form-label">å¤´åƒ</label>
            <div class="avatar-preview" id="editAvatarPreview">ğŸ‘¤</div>
            <label for="editAvatarInput" class="file-button">é€‰æ‹©å¤´åƒ</label>
            <input type="file" id="editAvatarInput" class="file-input" accept="image/*">
        </div>
        
        <div class="form-group">
            <label class="form-label">è§’è‰²åå­—</label>
            <input type="text" id="editCharName" class="form-input" placeholder="è¾“å…¥è§’è‰²åå­—">
        </div>
        
        <div class="form-group">
            <label class="form-label">åœ°å€</label>
            <input type="text" id="editCharAddress" class="form-input" placeholder="è¾“å…¥åœ°å€">
        </div>
        
        <div class="modal-buttons">
            <button class="btn btn-cancel" onclick="closeEditBasicInfo()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveBasicInfo()">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- å›¾æ ‡ç¼–è¾‘å¼¹çª— -->
<div class="modal-overlay" id="iconEditorModal" onclick="closeIconEditor(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-title">æ›´æ¢å›¾æ ‡</div>
        
        <div class="form-group">
            <label class="form-label">å½“å‰å›¾æ ‡é¢„è§ˆ</label>
            <div class="app-icon-preview" id="currentIconPreview" style="width: 80px; height: 80px; font-size: 36px;">ğŸŒ</div>
        </div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchIconTab('local')">æœ¬åœ°ç›¸å†Œ</button>
            <button class="tab-btn" onclick="switchIconTab('url')">ç½‘å€é“¾æ¥</button>
            <button class="tab-btn" onclick="resetToDefaultIcon()">æ¢å¤é»˜è®¤</button>
        </div>
        
        <div class="tab-content active" id="iconLocalTab" style="margin-top: 15px;">
            <div class="file-input-area" onclick="document.getElementById('iconFile').click()">
                <div>ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
                <input type="file" id="iconFile" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <div class="tab-content" id="iconUrlTab" style="margin-top: 15px;">
            <input type="url" class="url-input" id="iconUrl" placeholder="è¾“å…¥å›¾ç‰‡ç½‘å€...">
        </div>
        
        <div class="modal-buttons" style="margin-top: 20px;">
            <button class="btn btn-cancel" onclick="closeIconEditor()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveAppIcon()">ä¿å­˜</button>
        </div>
    </div>
</div>
<!-- åŸå¸‚ä¿¡æ¯è®¾ç½®å¼¹çª— -->
<div class="modal-overlay" id="cityInfoModal" onclick="closeCityInfoModal(event)">
    <div class="modal" onclick="event.stopPropagation()" style="max-width: 90%; width: 350px; max-height: 85vh; display: flex; flex-direction: column; padding: 20px;">
        
        <div class="modal-title" style="margin-bottom: 15px; flex-shrink: 0;">åŸå¸‚ä¿¡æ¯è®¾ç½®</div>
        
        <div style="flex: 1; overflow-y: auto; padding-right: 5px; margin-bottom: 15px;">
            
            <div class="form-group">
                <label class="form-label">è§’è‰²è™šæ‹Ÿåœ°å€</label>
                <input type="text" id="charVirtualAddress" class="form-input" placeholder="ä¾‹å¦‚ï¼šAåŸ">
            </div>
            
            <div class="form-group">
                <label class="form-label">è§’è‰²å‚è€ƒåœ°å€ï¼ˆä½¿ç”¨è‹±æ–‡ï¼‰</label>
                <input type="text" id="charRealAddress" class="form-input" placeholder="ä¾‹å¦‚ï¼šBeijing">
            </div>
            
            <div class="form-group">
                <label class="form-label">æˆ‘çš„è™šæ‹Ÿåœ°å€</label>
                <input type="text" id="myVirtualAddress" class="form-input" placeholder="ä¾‹å¦‚ï¼šBåŸ">
            </div>
            
            <div class="form-group">
                <label class="form-label">æˆ‘çš„å‚è€ƒåœ°å€ï¼ˆä½¿ç”¨è‹±æ–‡ï¼‰</label>
                <input type="text" id="myRealAddress" class="form-input" placeholder="ä¾‹å¦‚ï¼šShanghai">
            </div>
            
            <button class="api-btn" onclick="fetchWeatherData()">è·å–åœ°å€ä¿¡æ¯</button>
            
            <div id="weatherPreview" style="display: none; margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-size: 13px; line-height: 1.8;">
                </div>
        </div>

        <div class="modal-buttons" style="margin-top: 0; flex-shrink: 0;">
            <button class="btn btn-cancel" onclick="closeCityInfoModal()">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveCityInfo()">ä¿å­˜</button>
        </div>
    </div>
</div>


    <script>
        // IndexedDB æ“ä½œ
        let db;
        let currentWallpaper = null;
        // æ—¥è®°åŠŸèƒ½ç›¸å…³å˜é‡
let diaries = [];
let currentViewingDiaryId = null;

        function initDB() {
           const request = indexedDB.open('phoneData', 8);
            
            request.onerror = () => console.error('æ•°æ®åº“æ‰“å¼€å¤±è´¥');
            
            request.onsuccess = (event) => {
                db = event.target.result;
                loadUserInfo();
                loadWallpaper();
              loadWorldbooks();
              loadApiConfig();
loadApiSchemes();
              loadAppIcons();
              
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('userInfo')) {
                    db.createObjectStore('userInfo', { keyPath: 'id' });
                }
                if (!db.objectStoreNames.contains('wallpaper')) {
                    db.createObjectStore('wallpaper', { keyPath: 'id' });
                }
              if (!db.objectStoreNames.contains('worldbooks')) {
    db.createObjectStore('worldbooks', { keyPath: 'id', autoIncrement: true });
}
if (!db.objectStoreNames.contains('categories')) {
    db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
}
              if (!db.objectStoreNames.contains('apiConfig')) {
    db.createObjectStore('apiConfig', { keyPath: 'id' });
}
if (!db.objectStoreNames.contains('apiSchemes')) {
    db.createObjectStore('apiSchemes', { keyPath: 'id', autoIncrement: true });
}
if (!db.objectStoreNames.contains('chats')) {
    db.createObjectStore('chats', { keyPath: 'id', autoIncrement: true });
}
if (!db.objectStoreNames.contains('messages')) {
    db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
}
              if (!db.objectStoreNames.contains('characterInfo')) {
    db.createObjectStore('characterInfo', { keyPath: 'id' });
}if (!db.objectStoreNames.contains('appIcons')) {
    db.createObjectStore('appIcons', { keyPath: 'id' });
}if (!db.objectStoreNames.contains('diaries')) {
    db.createObjectStore('diaries', { keyPath: 'id', autoIncrement: true });
}



            };
        }
        
 function saveToDB(storeName, data) {
    const transaction = db.transaction([storeName], 'readwrite');
    const objectStore = transaction.objectStore(storeName);
    
    if (storeName === 'worldbooks' || storeName === 'categories' || storeName === 'chats' || storeName === 'messages') {
        objectStore.put({ id: 1, list: data.list || data });
    } else {
        objectStore.put({ id: 1, ...data });
    }
}
function loadFromDB(storeName, callback) {
    const transaction = db.transaction([storeName], 'readonly');
    const objectStore = transaction.objectStore(storeName);
    const request = objectStore.get(1);
    
    request.onsuccess = () => {
        if (storeName === 'worldbooks' || storeName === 'categories') {
            callback(request.result ? request.result.list : null);
        } else {
            callback(request.result);
        }
    };
}
        
        // é¡µé¢åˆ‡æ¢
     function openApp(appName) {
    if (appName === 'wallpaper') {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('wallpaperScreen').style.display = 'flex';
        updateWallpaperPreview();
    } else if (appName === 'world') {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('worldbookScreen').style.display = 'flex';
        loadWorldbooks();
    } else if (appName === 'api') {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('apiScreen').style.display = 'flex';
        loadApiConfig();
        renderApiSchemes();
    } else if (appName === 'chat') {
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('chatScreen').style.display = 'flex';
        loadChats();
    } 
    else {
        alert(`ç‚¹å‡»äº†${appName}åº”ç”¨`);
    }
}

        
    function backToMain() {
    // éšè—æ‰€æœ‰é¡µé¢
    document.getElementById('wallpaperScreen').style.display = 'none';
    document.getElementById('worldbookScreen').style.display = 'none';
      document.getElementById('apiScreen').style.display = 'none';
      document.getElementById('chatScreen').style.display = 'none';


    // æ˜¾ç¤ºä¸»å±å¹•
    document.getElementById('mainScreen').style.display = 'flex';
}
        
        // å£çº¸åŠŸèƒ½
        function switchTab(tabName) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        function updateWallpaperPreview() {
            const preview = document.getElementById('wallpaperPreview');
            if (currentWallpaper) {
                preview.innerHTML = `<img src="${currentWallpaper}" alt="å£çº¸é¢„è§ˆ">`;
            } else {
                preview.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }
        
        function saveWallpaper() {
            const fileInput = document.getElementById('wallpaperFile');
            const urlInput = document.getElementById('wallpaperUrl');
            
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentWallpaper = e.target.result;
                    applyWallpaper(currentWallpaper);
                    saveToDB('wallpaper', { data: currentWallpaper, type: 'local' });
                    backToMain();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else if (urlInput.value) {
                currentWallpaper = urlInput.value;
                applyWallpaper(currentWallpaper);
                saveToDB('wallpaper', { data: currentWallpaper, type: 'url' });
                backToMain();
            } else {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è¾“å…¥ç½‘å€');
            }
        }
        
        function applyWallpaper(wallpaperData) {
            if (wallpaperData) {
                document.body.style.background = `url(${wallpaperData}) center/cover no-repeat`;
            } else {
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }
        
        function loadWallpaper() {
            loadFromDB('wallpaper', (data) => {
                if (data && data.data) {
                    currentWallpaper = data.data;
                    applyWallpaper(currentWallpaper);
                }
            });
        }
        
        // æ–‡ä»¶é¢„è§ˆ
        document.getElementById('wallpaperFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('wallpaperPreview').innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
                };
                reader.readAsDataURL(file);
            }
        });
        
        document.getElementById('wallpaperUrl').addEventListener('input', function(e) {
            const url = e.target.value;
            if (url) {
                document.getElementById('wallpaperPreview').innerHTML = `<img src="${url}" alt="é¢„è§ˆ" onerror="this.style.display='none'">`;
            }
        });
        
        // ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½
        function openEditModal() {
            document.getElementById('editModal').style.display = 'flex';
            loadCurrentInfo();
        }
        
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('editModal').style.display = 'none';
        }
        
   function loadCurrentInfo() {
    document.getElementById('userIdInput').value = document.getElementById('mainUserId').textContent;
    document.getElementById('signatureInput').value = document.getElementById('mainSignature').textContent;
    
    // åŠ è½½å½“å‰é¢œè‰²
    loadFromDB('userInfo', (data) => {
        if (data) {
            const textColor = data.textColor || '#ffffff';
            const appTextColor = data.appTextColor || '#ffffff';
            
            document.getElementById('textColorInput').value = textColor;
            document.getElementById('appTextColorInput').value = appTextColor;
            
            // åŒæ­¥é¢„è§ˆæ¡†é¢œè‰²
            document.getElementById('textColorPreview').style.background = textColor;
            document.getElementById('appTextColorPreview').style.background = appTextColor;
        }
    });
}


        
 function saveUserInfo() {
    const userId = document.getElementById('userIdInput').value || 'æˆ‘çš„å°æ‰‹æœº';
    const signature = document.getElementById('signatureInput').value || 'ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå‘€ï½';
    const textColor = document.getElementById('textColorInput').value;
    const appTextColor = document.getElementById('appTextColorInput').value;
    const avatarFile = document.getElementById('avatarInput').files[0];
    
    if (avatarFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const avatarData = e.target.result;
            updateUI(userId, signature, avatarData, textColor, appTextColor);
            saveToDB('userInfo', { userId, signature, avatar: avatarData, textColor, appTextColor });
            // è§¦å‘å…¨å±€å¤´åƒæ›´æ–°äº‹ä»¶
window.dispatchEvent(new StorageEvent('storage', {
    key: 'userAvatar',
    newValue: avatarData
}));

          closeModal();
        };
        reader.readAsDataURL(avatarFile);
    } else {
        // æ²¡æœ‰æ–°å¤´åƒï¼Œä¿ç•™åŸæœ‰å¤´åƒ
        loadFromDB('userInfo', (data) => {
            const existingAvatar = data ? data.avatar : null;
            updateUI(userId, signature, existingAvatar, textColor, appTextColor);
            saveToDB('userInfo', { userId, signature, avatar: existingAvatar, textColor, appTextColor });
            closeModal();
        });
    }
}

        
    function updateUI(userId, signature, avatar, textColor, appTextColor) {
    document.getElementById('mainUserId').textContent = userId;
    document.getElementById('mainSignature').textContent = signature;
    
    if (avatar) {
        document.getElementById('mainAvatar').innerHTML = `<img src="${avatar}" alt="å¤´åƒ">`;
    }
    
    // åº”ç”¨å­—ä½“é¢œè‰²
    if (textColor) {
        document.getElementById('mainUserId').style.color = textColor;
        document.getElementById('mainSignature').style.color = textColor;
    }
    
    // åº”ç”¨Appå›¾æ ‡å­—ä½“é¢œè‰²
    if (appTextColor) {
        document.querySelectorAll('.app-name').forEach(el => {
            el.style.color = appTextColor;
        });
    }
}

     function loadUserInfo() {
    loadFromDB('userInfo', (data) => {
        if (data) {
            updateUI(data.userId, data.signature, data.avatar, data.textColor, data.appTextColor);
        }
    });
}

       // ç›‘å¬ç”¨æˆ·å¤´åƒæ›´æ–°äº‹ä»¶
window.addEventListener('storage', function(e) {
    if (e.key === 'userAvatar' || !e.key) {
        loadUserInfo();
    }
});
 
        // å¤´åƒé¢„è§ˆ
        document.getElementById('avatarInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('avatarPreview').innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
                };
                reader.readAsDataURL(file);
            }
        });
        // ä¸–ç•Œä¹¦åŠŸèƒ½
let worldbooks = [];
let categories = ['é»˜è®¤åˆ†ç±»'];
let currentCategory = 'all';
// APIè®¾ç½®ç›¸å…³å˜é‡
let apiSchemes = [];
let currentApiConfig = {
    name: '',
    baseUrl: '',
    apiKey: '',
    models: [],
    defaultModel: ''
};


function loadWorldbooks() {
    loadFromDB('worldbooks', (data) => {
        worldbooks = data || [];
        renderWorldbooks();
    });
    loadFromDB('categories', (data) => {
        categories = data || ['é»˜è®¤åˆ†ç±»'];
        renderCategories();
    });
}

function renderCategories() {
    const container = document.getElementById('categoryTags');
    container.innerHTML = '<div class="category-tag active" data-category="all">å…¨éƒ¨</div>';
    
    categories.forEach(cat => {
        container.innerHTML += `<div class="category-tag" data-category="${cat}">${cat}</div>`;
    });
    
    container.innerHTML += '<div class="category-tag" data-category="manage">ç®¡ç†åˆ†ç±»</div>';
    
    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.category-tag').forEach(tag => {
        tag.addEventListener('click', () => switchCategory(tag.dataset.category));
    });
}

function switchCategory(category) {
    if (category === 'manage') {
        openCategoryManager();
        return;
    }
    
    currentCategory = category;
    document.querySelectorAll('.category-tag').forEach(tag => tag.classList.remove('active'));
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    renderWorldbooks();
}

function renderWorldbooks() {
    const container = document.getElementById('worldbookList');
    const filtered = currentCategory === 'all' ? worldbooks : worldbooks.filter(wb => wb.category === currentCategory);
    
    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">æš‚æ— ä¸–ç•Œä¹¦</div>';
        return;
    }
    
    container.innerHTML = filtered.map(wb => `
        <div class="worldbook-card">
            <div class="card-title">${wb.title}</div>
            <div class="card-preview">${wb.content.substring(0, 100)}...</div>
            <div class="card-footer">
                <div class="card-category">${wb.category}</div>
                <div class="card-actions">
                    <button class="action-btn btn-edit" onclick="editWorldbook(${wb.id})">ç¼–è¾‘</button>
                    <button class="action-btn btn-delete" onclick="deleteWorldbook(${wb.id})">åˆ é™¤</button>
                </div>
            </div>
        </div>
    `).join('');
}

function openAddWorldbook() {
    alert('æ·»åŠ ä¸–ç•Œä¹¦åŠŸèƒ½å¼€å‘ä¸­...');
}

function editWorldbook(id) {
    alert(`ç¼–è¾‘ä¸–ç•Œä¹¦ ${id}`);
}

function deleteWorldbook(id) {
    if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿ')) {
        worldbooks = worldbooks.filter(wb => wb.id !== id);
        saveToDB('worldbooks', worldbooks);
        renderWorldbooks();
    }
}
let editingWorldbookId = null;

function openAddWorldbook() {
    editingWorldbookId = null;
    document.getElementById('worldbookModalTitle').textContent = 'æ·»åŠ ä¸–ç•Œä¹¦';
    document.getElementById('worldbookTitle').value = '';
    document.getElementById('worldbookContent').value = '';
    updateCategorySelect();
    document.getElementById('worldbookModal').style.display = 'flex';
}

function editWorldbook(id) {
    const worldbook = worldbooks.find(wb => wb.id === id);
    if (worldbook) {
        editingWorldbookId = id;
        document.getElementById('worldbookModalTitle').textContent = 'ç¼–è¾‘ä¸–ç•Œä¹¦';
        document.getElementById('worldbookTitle').value = worldbook.title;
        document.getElementById('worldbookContent').value = worldbook.content;
        document.getElementById('worldbookCategory').value = worldbook.category;
        updateCategorySelect();
        document.getElementById('worldbookModal').style.display = 'flex';
    }
}

function closeWorldbookModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('worldbookModal').style.display = 'none';
}

function updateCategorySelect() {
    const select = document.getElementById('worldbookCategory');
    select.innerHTML = categories.map(cat => 
        `<option value="${cat}">${cat}</option>`
    ).join('');
}

function saveWorldbook() {
    const title = document.getElementById('worldbookTitle').value.trim();
    const content = document.getElementById('worldbookContent').value.trim();
    const category = document.getElementById('worldbookCategory').value;
    
    if (!title || !content) {
        alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
        return;
    }
    
    if (editingWorldbookId) {
        // ç¼–è¾‘ç°æœ‰ä¸–ç•Œä¹¦
        const index = worldbooks.findIndex(wb => wb.id === editingWorldbookId);
        worldbooks[index] = { ...worldbooks[index], title, content, category };
    } else {
        // æ·»åŠ æ–°ä¸–ç•Œä¹¦
        const newId = worldbooks.length > 0 ? Math.max(...worldbooks.map(wb => wb.id)) + 1 : 1;
        worldbooks.push({ id: newId, title, content, category, createTime: new Date().toISOString() });
    }
    
    saveToDB('worldbooks', worldbooks);
    renderWorldbooks();
    closeWorldbookModal();
}
// åˆ†ç±»ç®¡ç†åŠŸèƒ½
function openCategoryManager() {
    renderCategoryList();
    document.getElementById('categoryModal').style.display = 'flex';
}

function closeCategoryModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('categoryModal').style.display = 'none';
}

function renderCategoryList() {
    const container = document.getElementById('categoryList');
    container.innerHTML = categories.map(cat => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
            <span>${cat}</span>
            ${cat !== 'é»˜è®¤åˆ†ç±»' ? `<button class="action-btn btn-delete" onclick="deleteCategory('${cat}')">åˆ é™¤</button>` : ''}
        </div>
    `).join('');
}

function addCategory() {
    const name = document.getElementById('newCategoryName').value.trim();
    if (!name) {
        alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
        return;
    }
    if (categories.includes(name)) {
        alert('åˆ†ç±»å·²å­˜åœ¨');
        return;
    }
    
    categories.push(name);
    saveToDB('categories', categories);
    renderCategories();
    renderCategoryList();
    document.getElementById('newCategoryName').value = '';
}

function deleteCategory(categoryName) {
    if (confirm(`ç¡®å®šåˆ é™¤åˆ†ç±»"${categoryName}"å—ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹çš„ä¸–ç•Œä¹¦å°†ç§»åŠ¨åˆ°é»˜è®¤åˆ†ç±»ã€‚`)) {
        // å°†è¯¥åˆ†ç±»ä¸‹çš„ä¸–ç•Œä¹¦ç§»åŠ¨åˆ°é»˜è®¤åˆ†ç±»
        worldbooks.forEach(wb => {
            if (wb.category === categoryName) {
                wb.category = 'é»˜è®¤åˆ†ç±»';
            }
        });
        
        // åˆ é™¤åˆ†ç±»
        categories = categories.filter(cat => cat !== categoryName);
        
        // ä¿å­˜æ•°æ®
        saveToDB('categories', categories);
        saveToDB('worldbooks', worldbooks);
        
        // æ›´æ–°ç•Œé¢
        renderCategories();
        renderCategoryList();
        renderWorldbooks();
        
        // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¢«åˆ é™¤çš„åˆ†ç±»ï¼Œåˆ‡æ¢åˆ°å…¨éƒ¨
        if (currentCategory === categoryName) {
            currentCategory = 'all';
        }
    }
}
// APIè®¾ç½®åŠŸèƒ½å‡½æ•°
function loadApiConfig() {
    loadFromDB('apiConfig', (data) => {
        if (data) {
            currentApiConfig = data;
            updateApiForm();
        }
    });
}

function loadApiSchemes() {
    loadFromDB('apiSchemes', (data) => {
        // ç¡®ä¿è¿”å›æ•°ç»„
        if (Array.isArray(data)) {
            apiSchemes = data;
        } else if (data && data.list) {
            apiSchemes = data.list;
        } else {
            apiSchemes = [];
        }
        renderApiSchemes();
    });
}

function renderApiSchemes() {
    const select = document.getElementById('apiSchemeSelect');
    select.innerHTML = '<option value="">é€‰æ‹©æ–¹æ¡ˆ</option>';
    apiSchemes.forEach(scheme => {
        select.innerHTML += `<option value="${scheme.id}">${scheme.name}</option>`;
    });
}

function updateApiForm() {
    document.getElementById('apiName').value = currentApiConfig.name || '';
    document.getElementById('apiBaseUrl').value = currentApiConfig.baseUrl || '';
    document.getElementById('apiKey').value = currentApiConfig.apiKey || '';
    
    if (currentApiConfig.models && currentApiConfig.models.length > 0) {
        const modelSelect = document.getElementById('modelSelect');
        modelSelect.innerHTML = currentApiConfig.models.map(model => 
            `<option value="${model}" ${model === currentApiConfig.defaultModel ? 'selected' : ''}>${model}</option>`
        ).join('');
        document.getElementById('modelGroup').style.display = 'block';
    }
}

function newScheme() {
    currentApiConfig = { name: '', baseUrl: '', apiKey: '', models: [], defaultModel: '' };
    updateApiForm();
    document.getElementById('apiSchemeSelect').value = '';
}

function deleteScheme() {
    const selectId = document.getElementById('apiSchemeSelect').value;
    if (!selectId) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–¹æ¡ˆ');
        return;
    }
    
    if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿ')) {
        apiSchemes = apiSchemes.filter(s => s.id != selectId);
      const transaction = db.transaction(['apiSchemes'], 'readwrite');
const objectStore = transaction.objectStore('apiSchemes');
objectStore.put({ id: 1, list: apiSchemes });

        renderApiSchemes();
        newScheme();
    }
}
async function getModels() {
    const baseUrl = document.getElementById('apiBaseUrl').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    
    if (!baseUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’ŒAPIå¯†é’¥');
        return;
    }
    
    try {
        const url = baseUrl.endsWith('/') ? baseUrl + 'models' : baseUrl + '/models';
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('è·å–æ¨¡å‹å¤±è´¥');
        }
        
        const data = await response.json();
        const models = data.data.map(model => model.id);
        
        currentApiConfig.models = models;
        const modelSelect = document.getElementById('modelSelect');
        modelSelect.innerHTML = models.map(model => 
            `<option value="${model}">${model}</option>`
        ).join('');
        document.getElementById('modelGroup').style.display = 'block';
        
        alert('æˆåŠŸè·å– ' + models.length + ' ä¸ªæ¨¡å‹');
    } catch (error) {
        alert('è·å–æ¨¡å‹å¤±è´¥ï¼š' + error.message);
    }
}

async function testConnection() {
    const baseUrl = document.getElementById('apiBaseUrl').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    
    if (!baseUrl || !apiKey) {
        alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’ŒAPIå¯†é’¥');
        return;
    }
    
    try {
        const url = baseUrl.endsWith('/') ? baseUrl + 'models' : baseUrl + '/models';
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            alert('è¿æ¥æˆåŠŸï¼âœ…');
        } else {
            alert('è¿æ¥å¤±è´¥ï¼š' + response.status);
        }
    } catch (error) {
        alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
    }
}

function saveConfig() {
    const name = document.getElementById('apiName').value.trim();
    const baseUrl = document.getElementById('apiBaseUrl').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    const defaultModel = document.getElementById('modelSelect').value;
    
    if (!baseUrl || !apiKey) {
        alert('è¯·è‡³å°‘å¡«å†™åä»£åœ°å€å’ŒAPIå¯†é’¥');
        return;
    }
    
    currentApiConfig = {
        name: name || 'ä¸´æ—¶é…ç½®',
        baseUrl,
        apiKey,
        models: currentApiConfig.models,
        defaultModel
    };
    
    saveToDB('apiConfig', currentApiConfig);
    alert('é…ç½®å·²ä¿å­˜');
}

function saveAsScheme() {
    const name = document.getElementById('apiName').value.trim();
    const baseUrl = document.getElementById('apiBaseUrl').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    const defaultModel = document.getElementById('modelSelect').value;
    
    if (!name) {
        alert('è¯·è¾“å…¥æ–¹æ¡ˆåç§°');
        return;
    }
    
    if (!baseUrl || !apiKey) {
        alert('è¯·å¡«å†™åä»£åœ°å€å’ŒAPIå¯†é’¥');
        return;
    }
    
    const selectId = document.getElementById('apiSchemeSelect').value;
    
    if (selectId) {
        // æ›´æ–°ç°æœ‰æ–¹æ¡ˆ
        const index = apiSchemes.findIndex(s => s.id == selectId);
        apiSchemes[index] = {
            ...apiSchemes[index],
            name,
            baseUrl,
            apiKey,
            models: currentApiConfig.models,
            defaultModel
        };
    } else {
        // æ–°å»ºæ–¹æ¡ˆ
        const newId = apiSchemes.length > 0 ? Math.max(...apiSchemes.map(s => s.id)) + 1 : 1;
        apiSchemes.push({
            id: newId,
            name,
            baseUrl,
            apiKey,
            models: currentApiConfig.models,
            defaultModel
        });
    }
    
    // æ·»åŠ è¿™è¡Œä»£ç ï¼Œç¡®ä¿ä»¥æ•°ç»„æ ¼å¼ä¿å­˜
    const transaction = db.transaction(['apiSchemes'], 'readwrite');
    const objectStore = transaction.objectStore('apiSchemes');
    objectStore.put({ id: 1, list: apiSchemes });
    
    renderApiSchemes();
    alert('æ–¹æ¡ˆå·²ä¿å­˜');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {

    
    // æ–¹æ¡ˆé€‰æ‹©åˆ‡æ¢äº‹ä»¶
    const schemeSelect = document.getElementById('apiSchemeSelect');
    if (schemeSelect) {
        schemeSelect.addEventListener('change', function(e) {
            const schemeId = e.target.value;
            if (!schemeId) {
                newScheme();
                return;
            }
            
            const scheme = apiSchemes.find(s => s.id == schemeId);
            if (scheme) {
                currentApiConfig = { ...scheme };
                updateApiForm();
            }
        });
    }
      // é¢œè‰²é€‰æ‹©å™¨å®æ—¶é¢„è§ˆ
    const textColorInput = document.getElementById('textColorInput');
    const appTextColorInput = document.getElementById('appTextColorInput');
    
    if (textColorInput) {
        textColorInput.addEventListener('input', function(e) {
            document.getElementById('textColorPreview').style.background = e.target.value;
        });
    }
    
    if (appTextColorInput) {
        appTextColorInput.addEventListener('input', function(e) {
            document.getElementById('appTextColorPreview').style.background = e.target.value;
        });
    }
      // ç»‘å®šä¸Šä¸‹æ–‡å‚è€ƒçš„æ»‘åŠ¨æ¡å’Œè¾“å…¥æ¡†äº‹ä»¶
    setTimeout(() => {
        const slider = document.getElementById('contextRoundsSlider');
        const input = document.getElementById('contextRoundsInput');
        
        if (slider) {
            slider.addEventListener('input', function() {
                syncContextRounds('slider');
            });
        }
        
        if (input) {
            input.addEventListener('input', function() {
                syncContextRounds('input');
            });
            
            // é˜²æ­¢è¾“å…¥éæ³•å€¼
            input.addEventListener('blur', function() {
                let value = parseInt(this.value) || 0;
                if (value < 0) value = 0;
                if (value > 300) value = 300;
                this.value = value;
                slider.value = value;
                syncContextRounds('slider');
            });
        }
    }, 600);

});
// èŠå¤©åŠŸèƒ½ç›¸å…³å˜é‡
let chats = [];
let currentChatTab = 'single'; // single, group, peek

// åŠ è½½èŠå¤©åˆ—è¡¨
function loadChats() {
    loadFromDB('chats', (data) => {
        // ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„æ ¼å¼
        if (data && data.list) {
            chats = data.list;
        } else if (Array.isArray(data)) {
            chats = data;
        } else {
            chats = [];
        }
        renderChatList();
    });
}

// åˆ‡æ¢èŠå¤©åˆ†ç»„
function switchChatTab(tab) {
    currentChatTab = tab;
    
    // æ›´æ–°æ ‡ç­¾çŠ¶æ€ï¼ˆæ”¹è¿™é‡Œï¼‰
    document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.bottom-tab[data-tab="${tab}"]`).classList.add('active');
    
    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    renderChatList();
}

// æ¸²æŸ“èŠå¤©åˆ—è¡¨
function renderChatList() {
    const container = document.getElementById('chatListContainer');
    
    // æ ¹æ®å½“å‰åˆ†ç»„ç­›é€‰
    let filtered = chats.filter(chat => chat.type === currentChatTab);
    
    // æ’åºï¼šç½®é¡¶çš„åœ¨å‰ï¼Œå…¶ä»–æŒ‰æ—¶é—´æ’åº
    filtered.sort((a, b) => {
        if (a.isPinned && !b.isPinned) return -1;
        if (!a.isPinned && b.isPinned) return 1;
        if (a.isPinned && b.isPinned) {
            return new Date(b.pinnedTime) - new Date(a.pinnedTime);
        }
        const timeA = a.lastMessageTime || a.createTime;
        const timeB = b.lastMessageTime || b.createTime;
        return new Date(timeB) - new Date(timeA);
    });
    
    if (filtered.length === 0) {
        const emptyText = currentChatTab === 'single' ? 'æš‚æ— å•èŠ' : 
                         currentChatTab === 'group' ? 'æš‚æ— ç¾¤èŠ' : 
                         'æš‚æ— å·çœ‹çš„ç¾¤èŠ';
        container.innerHTML = `<div style="text-align: center; color: #999; margin-top: 50px;">${emptyText}</div>`;
        return;
    }
    
    // å…ˆæ¸²æŸ“åŸºç¡€HTMLï¼ˆç”¨åŸå§‹è§’è‰²åï¼‰
    container.innerHTML = filtered.map(chat => `
        <div class="chat-item-wrapper" id="wrapper-${chat.id}">
            <div class="chat-item" id="chat-${chat.id}">
                <div class="chat-avatar">
                    ${chat.avatarImage ? `<img src="${chat.avatarImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : chat.avatar}
                </div>
                <div class="chat-info">
                    <div class="chat-top">
                      <div class="chat-name" data-chat-id="${chat.id}" data-original-name="${chat.name}">
    ${chat.name}
    <span class="status-tag" id="status-tag-${chat.id}"></span>
    ${chat.isPinned ? '<span class="pin-badge">ğŸ“Œ</span>' : ''}
</div>

                        <div class="chat-time">${formatChatListTime(chat.lastMessageTime || chat.createTime)}</div>
                    </div>
                    <div class="chat-bottom">
                        <div class="chat-preview">${chat.lastMessage}</div>
                        ${chat.unread > 0 ? `<div class="chat-badge">${chat.unread}</div>` : ''}
                    </div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="action-btn-slide action-pin" onclick="togglePin(${chat.id})">
                    ${chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}
                </button>
                <button class="action-btn-slide action-delete" onclick="deleteChat(${chat.id})">
                    åˆ é™¤
                </button>
            </div>
        </div>
    `).join('');
    
    // ç„¶åå¼‚æ­¥æ›´æ–°å¤‡æ³¨ï¼ˆä¸é˜»å¡ä¸»è¿›ç¨‹ï¼‰
    filtered.forEach(chat => {
        updateChatDisplayName(chat.id);
    updateChatStatusDisplay(chat.id);
    addSwipeEvent(chat.id);
    });
}

// æ–°å¢å‡½æ•°ï¼šå¼‚æ­¥æ›´æ–°èŠå¤©æ˜¾ç¤ºåç§°
function updateChatDisplayName(chatId) {
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        const displayName = (charData.remark && charData.remark.trim()) ? charData.remark : null;
        
        if (displayName) {
            const nameElement = document.querySelector(`.chat-name[data-chat-id="${chatId}"]`);
            if (nameElement) {
                const originalName = nameElement.dataset.originalName;
                const pinBadge = nameElement.querySelector('.pin-badge');
                const statusTag = nameElement.querySelector('.status-tag');
                
                nameElement.textContent = displayName;
                
                if (statusTag) {
                    nameElement.appendChild(statusTag);
                }
                
                if (pinBadge) {
                    nameElement.appendChild(pinBadge);
                }
            }
        }
    });
}

function updateChatStatusDisplay(chatId) {
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        const status = charData.currentStatus || 'åœ¨çº¿-åˆšåˆšä¸Šçº¿';  // â† ç»™é»˜è®¤å€¼
        
        const statusTag = document.getElementById(`status-tag-${chatId}`);
        if (statusTag && status) {  // â† åˆ é™¤äº†é¢å¤–çš„åˆ¤æ–­
            const mainStatus = status.split('-')[0].trim();
            statusTag.textContent = `ã€Œ${mainStatus}ã€`;
        } else if (statusTag) {
            statusTag.textContent = '';
        }
    });
}


// æ›´æ–°è¯¦æƒ…é¡µçŠ¶æ€æ˜¾ç¤º
function updateDetailPageStatus(chatId) {
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        const status = charData.currentStatus || 'åœ¨çº¿-åˆšåˆšä¸Šçº¿';
        
        const statusElement = document.getElementById('characterStatus');
        if (statusElement) {
            statusElement.textContent = status;
            statusElement.style.display = 'block';
    
        }
    });
}

// æ–°å¢å‡½æ•°ï¼šæ›´æ–°è¯¦æƒ…é¡µæ ‡é¢˜
function updateDetailPageTitle(chatId, originalName) {
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        const displayName = (charData.remark && charData.remark.trim()) ? charData.remark : originalName;
        document.getElementById('chatDetailTitle').textContent = displayName;
    });
}



// æ‰“å¼€æ·»åŠ èŠå¤©èœå•
function openAddChatMenu() {
    if (currentChatTab === 'single') {
        // å•èŠï¼šæ‰“å¼€è¾“å…¥å¼¹çª—
        document.getElementById('singleChatName').value = '';
        document.getElementById('addSingleChatModal').style.display = 'flex';
    } else if (currentChatTab === 'group') {
        // ç¾¤èŠï¼šæ‰“å¼€æˆå‘˜é€‰æ‹©å¼¹çª—
        openMemberSelector('group');
    } else if (currentChatTab === 'peek') {
        // å·çœ‹ï¼šæ‰“å¼€æˆå‘˜é€‰æ‹©å¼¹çª—
        openMemberSelector('peek');
    }
}

// æ‰“å¼€èŠå¤©è¯¦æƒ…
function openChatDetail(chatId) {
    currentChatId = chatId;
    allMessages = [];
    visibleMessagesCount = 30;
    
    const chat = chats.find(c => c.id === chatId);
    if (!chat) return;
    
    // è®¾ç½®æ ‡é¢˜ - åŠ¨æ€è·å–å¤‡æ³¨
updateDetailPageTitle(chatId, chat.name);
    // æ˜¾ç¤ºè§’è‰²çŠ¶æ€
updateDetailPageStatus(chatId);
// æ£€æŸ¥å¹¶æ›´æ–°å¤©æ°”ä¿¡æ¯
checkAndUpdateWeather(chatId);

    // éšè—èŠå¤©åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…é¡µ
    document.getElementById('chatScreen').style.display = 'none';
    document.getElementById('chatDetailScreen').style.display = 'flex';
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå·çœ‹æ¨¡å¼
    const chatInput = document.getElementById('chatInput');
    
    if (chat.type === 'peek') {
        chatInput.disabled = true;
        chatInput.placeholder = 'ğŸ‘€ å·çœ‹æ¨¡å¼ï¼Œæ— æ³•å‘é€æ¶ˆæ¯';
    } else {
        chatInput.disabled = false;
        chatInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
    }
    
    // åŠ è½½æ¶ˆæ¯
    loadMessages(chatId);
}





// æ‰“å¼€æœ‹å‹åœˆ
function openMoments() {
    alert('æœ‹å‹åœˆåŠŸèƒ½å¼€å‘ä¸­...');
}
// å…³é—­å•èŠå¼¹çª—
function closeAddSingleModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('addSingleChatModal').style.display = 'none';
}

// åˆ›å»ºå•èŠ
function createSingleChat() {
    const name = document.getElementById('singleChatName').value.trim();
    
    if (!name) {
        alert('è¯·è¾“å…¥è§’è‰²åå­—');
        return;
    }
    
    // ç”Ÿæˆæ–°ID
    const newId = chats.length > 0 ? Math.max(...chats.map(c => c.id)) + 1 : 1;
    
    // åˆ›å»ºå•èŠæ•°æ®
  const currentTime = getCurrentTime();
const newChat = {
    id: newId,
    type: 'single',
    name: name,
    avatar: 'ğŸ‘¤',
   avatarImage: null,
    lastMessage: '',
    time: 'åˆšåˆš',
    lastMessageTime: currentTime,
    unread: 0,
    isPinned: false,
    members: [],
    isPeek: false,
    createTime: currentTime,
  
};
    // åŒæ­¥ç”¨æˆ·å¤´åƒåˆ°æ–°åˆ›å»ºçš„å•èŠ
    loadFromDB('userInfo', (userData) => {
        if (userData && userData.avatar) {
            newChat.avatarImage = userData.avatar;
            saveToDB('chats', { list: chats });
            renderChatList();
        }
    });

    // æ·»åŠ åˆ°åˆ—è¡¨
    chats.push(newChat);
 saveToDB('chats', { list: chats });

    
    // åˆ·æ–°æ˜¾ç¤º
    renderChatList();
    closeAddSingleModal();
}

// æ‰“å¼€æˆå‘˜é€‰æ‹©å¼¹çª—
let selectingForType = ''; // 'group' æˆ– 'peek'
let selectedMembers = [];

function openMemberSelector(type) {
    selectingForType = type;
    selectedMembers = [];
    
    // è·å–æ‰€æœ‰å•èŠåˆ—è¡¨
    const singleChats = chats.filter(c => c.type === 'single');
    
    if (singleChats.length === 0) {
        alert('è¯·å…ˆæ·»åŠ å•èŠè”ç³»äºº');
        return;
    }
    
   // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
const membersList = document.getElementById('membersList');
membersList.innerHTML = singleChats.map(chat => {
    // ä¼˜å…ˆä½¿ç”¨avatarImageï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”¨emoji
    const avatarHtml = chat.avatarImage 
        ? `<img src="${chat.avatarImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
        : chat.avatar;
    
    return `
        <div class="member-item" onclick="toggleMemberSelection('${chat.name}', ${chat.id})">
            <input type="checkbox" class="member-checkbox" id="member-${chat.id}" onclick="event.stopPropagation(); toggleMemberSelection('${chat.name}', ${chat.id})">
            <div class="member-avatar">${avatarHtml}</div>
            <div class="member-name">${chat.name}</div>
        </div>
    `;
}).join('');

    
    // æ›´æ–°å·²é€‰æ•°é‡
    document.getElementById('selectedCount').textContent = '0';
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('selectMembersModal').style.display = 'flex';
}

// åˆ‡æ¢æˆå‘˜é€‰æ‹©
function toggleMemberSelection(memberName, chatId) {
    const index = selectedMembers.indexOf(memberName);
    const checkbox = document.getElementById(`member-${chatId}`);
    
    if (index > -1) {
        // å–æ¶ˆé€‰æ‹©
        selectedMembers.splice(index, 1);
        if (checkbox) checkbox.checked = false;
    } else {
        // æ·»åŠ é€‰æ‹©
        selectedMembers.push(memberName);
        if (checkbox) checkbox.checked = true;
    }
    
    // æ›´æ–°å·²é€‰æ•°é‡
    document.getElementById('selectedCount').textContent = selectedMembers.length;
}


// å…³é—­æˆå‘˜é€‰æ‹©å¼¹çª—
function closeSelectMembersModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('selectMembersModal').style.display = 'none';
    selectedMembers = [];
}

// ç¡®è®¤æˆå‘˜é€‰æ‹©
function confirmMemberSelection() {
    if (selectedMembers.length < 2) {
        alert('è¯·è‡³å°‘é€‰æ‹©2äºº');
        return;
    }
    
    if (selectingForType === 'group') {
        createGroupChat();
    } else if (selectingForType === 'peek') {
        createPeekChat();
    }
}

// åˆ›å»ºç¾¤èŠ
function createGroupChat() {
    const newId = chats.length > 0 ? Math.max(...chats.map(c => c.id)) + 1 : 1;
const currentTime = getCurrentTime();
const newChat = {
    id: newId,
    type: 'group',
    name: 'æœªå‘½åç¾¤èŠ',
    avatar: 'ğŸ‘¥',
    lastMessage: 'ç¾¤èŠå·²åˆ›å»º',
    time: 'åˆšåˆš',
    lastMessageTime: currentTime,
    unread: 0,
    isPinned: false,
    members: [...selectedMembers],
    isPeek: false,
    createTime: currentTime
};

    
    chats.push(newChat);
   saveToDB('chats', { list: chats });
    
    // åˆ‡æ¢åˆ°ç¾¤èŠåˆ†ç»„å¹¶åˆ·æ–°
    currentChatTab = 'group';
    document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.bottom-tab[data-tab="group"]').classList.add('active');
    renderChatList();
    
    closeSelectMembersModal();
}

// åˆ›å»ºå·çœ‹
function createPeekChat() {
    const newId = chats.length > 0 ? Math.max(...chats.map(c => c.id)) + 1 : 1;
    
   const currentTime = getCurrentTime();
const newChat = {
    id: newId,
    type: 'peek',
    name: 'ğŸ‘€æœªå‘½åç¾¤èŠ',
    avatar: 'ğŸ‘¥',
    lastMessage: 'ç¾¤èŠå·²åˆ›å»º',
    time: 'åˆšåˆš',
    lastMessageTime: currentTime,
    unread: 0,
    isPinned: false,
    members: [...selectedMembers],
    isPeek: false,
    createTime: currentTime
};

    
    chats.push(newChat);
   saveToDB('chats', { list: chats });
    
    // åˆ‡æ¢åˆ°å·çœ‹åˆ†ç»„å¹¶åˆ·æ–°
    currentChatTab = 'peek';
    document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.bottom-tab[data-tab="peek"]').classList.add('active');
    renderChatList();
    
    closeSelectMembersModal();
}
// å·¦æ»‘åŠŸèƒ½ç›¸å…³å˜é‡
let swipeStartX = 0;
let swipeCurrentX = 0;
let isSwiping = false;
let currentSwipedId = null;

// æ·»åŠ æ»‘åŠ¨äº‹ä»¶
function addSwipeEvent(chatId) {
    const wrapper = document.getElementById(`wrapper-${chatId}`);
    const chatItem = document.getElementById(`chat-${chatId}`);
    const actions = wrapper.querySelector('.chat-actions');
    if (!chatItem || !actions) return;
    
    // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
    chatItem.addEventListener('touchstart', (e) => {
        swipeStartX = e.touches[0].clientX;
        isSwiping = true;
    });
    
    chatItem.addEventListener('touchmove', (e) => {
        if (!isSwiping) return;
        swipeCurrentX = e.touches[0].clientX;
        const diff = swipeStartX - swipeCurrentX;
        
        if (diff > 0 && diff < 160) {
            chatItem.style.transform = `translateX(-${diff}px)`;
            actions.style.transform = `translateX(${100 - (diff / 160) * 100}%)`;
        }
    });
    
    chatItem.addEventListener('touchend', () => {
        if (!isSwiping) return;
        const diff = swipeStartX - swipeCurrentX;
        
        if (diff > 50) {
            chatItem.style.transform = 'translateX(-160px)';
            actions.style.transform = 'translateX(0)';
            closeOtherSwipes(chatId);
            currentSwipedId = chatId;
        } else {
            chatItem.style.transform = 'translateX(0)';
            actions.style.transform = 'translateX(100%)';
        }
        
        isSwiping = false;
    });
    
// é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
let mouseDownX = 0;
let hasMoved = false;
let actualSwipeDistance = 0;

chatItem.addEventListener('mousedown', (e) => {
    mouseDownX = e.clientX;
    swipeStartX = e.clientX;
    hasMoved = false;
    actualSwipeDistance = 0;
    chatItem.style.cursor = 'grabbing';
});

chatItem.addEventListener('mousemove', (e) => {
    // å¦‚æœé¼ æ ‡æ²¡æŒ‰ä¸‹ï¼Œç›´æ¥è¿”å›
    if (mouseDownX === 0) return;
    
    const diff = Math.abs(e.clientX - mouseDownX);
    if (diff > 5) {
        hasMoved = true;
        isSwiping = true;
    }
    
    if (!isSwiping) return;
    
    swipeCurrentX = e.clientX;
    actualSwipeDistance = swipeStartX - swipeCurrentX;
    
    if (actualSwipeDistance > 0 && actualSwipeDistance < 160) {
        chatItem.style.transform = `translateX(-${actualSwipeDistance}px)`;
        actions.style.transform = `translateX(${100 - (actualSwipeDistance / 160) * 100}%)`;
    }
});

chatItem.addEventListener('mouseup', (e) => {
    if (!hasMoved) {
        // æ²¡æœ‰ç§»åŠ¨ï¼Œæ˜¯ç‚¹å‡»äº‹ä»¶
        openChatDetail(chatId);
        chatItem.style.cursor = 'pointer';
        mouseDownX = 0;
        return;
    }
    
    // æœ‰ç§»åŠ¨ï¼Œåˆ¤æ–­æœ€ç»ˆæ»‘åŠ¨è·ç¦»
    if (actualSwipeDistance > 50) {
        // æ»‘åŠ¨è¶…è¿‡50pxï¼Œä¿æŒå±•å¼€
        chatItem.style.transform = 'translateX(-160px)';
        actions.style.transform = 'translateX(0)';
        closeOtherSwipes(chatId);
        currentSwipedId = chatId;
    } else {
        // æ»‘åŠ¨ä¸è¶³ï¼Œæ”¶å›
        chatItem.style.transform = 'translateX(0)';
        actions.style.transform = 'translateX(100%)';
    }
    
    isSwiping = false;
    hasMoved = false;
    actualSwipeDistance = 0;
    mouseDownX = 0;
    chatItem.style.cursor = 'pointer';
});

chatItem.addEventListener('mouseleave', () => {
    if (isSwiping) {
        // é¼ æ ‡ç¦»å¼€æ—¶ï¼Œæ ¹æ®å½“å‰æ»‘åŠ¨è·ç¦»å†³å®š
        if (actualSwipeDistance > 50) {
            chatItem.style.transform = 'translateX(-160px)';
            actions.style.transform = 'translateX(0)';
            closeOtherSwipes(chatId);
            currentSwipedId = chatId;
        } else {
            chatItem.style.transform = 'translateX(0)';
            actions.style.transform = 'translateX(100%)';
        }
        isSwiping = false;
    }
    hasMoved = false;
    actualSwipeDistance = 0;
    mouseDownX = 0;
    chatItem.style.cursor = 'pointer';
});


}



// å…³é—­å…¶ä»–å±•å¼€çš„æ»‘åŠ¨é¡¹
function closeOtherSwipes(exceptId) {
    chats.forEach(chat => {
        if (chat.id !== exceptId) {
            const item = document.getElementById(`chat-${chat.id}`);
            const wrapper = document.getElementById(`wrapper-${chat.id}`);
            if (item && wrapper) {
                item.style.transform = 'translateX(0)';
                const actions = wrapper.querySelector('.chat-actions');
                if (actions) {
                    actions.style.transform = 'translateX(100%)';
                }
            }
        }
    });
}




// ç½®é¡¶/å–æ¶ˆç½®é¡¶
function togglePin(chatId) {
    const chat = chats.find(c => c.id === chatId);
    if (!chat) return;
    
    chat.isPinned = !chat.isPinned;
    chat.pinnedTime = chat.isPinned ? new Date().toISOString() : null;
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveToDB('chats', { list: chats });
    
    // æ”¶èµ·æ»‘åŠ¨å¹¶åˆ·æ–°åˆ—è¡¨
    const item = document.getElementById(`chat-${chatId}`);
    if (item) {
        item.style.transform = 'translateX(0)';
    }
    
    renderChatList();
}

// åˆ é™¤èŠå¤©
function deleteChat(chatId) {
    if (!confirm('ç¡®å®šåˆ é™¤è¯¥èŠå¤©å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤')) {
        return;
    }
    
    // ä»æ•°ç»„ä¸­åˆ é™¤
    chats = chats.filter(c => c.id !== chatId);
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveToDB('chats', { list: chats });
    
    // åˆ·æ–°åˆ—è¡¨
    renderChatList();
}
// èŠå¤©è¯¦æƒ…ç›¸å…³å˜é‡
let currentChatId = null;
let allMessages = [];
let visibleMessagesCount = 30;

// è¿”å›èŠå¤©åˆ—è¡¨
function backToChatList() {
    document.getElementById('chatDetailScreen').style.display = 'none';
    document.getElementById('chatScreen').style.display = 'flex';
    
    // æ¸…ç†çŠ¶æ€
    currentChatId = null;
    allMessages = [];
    visibleMessagesCount = 30;
}


// åŠ è½½æ¶ˆæ¯
function loadMessages(chatId) {
    loadFromDB('messages', (data) => {
        const allData = data && data.list ? data.list : [];
        // åªåŠ è½½å½“å‰chatIdçš„æ¶ˆæ¯
        const chatMessages = allData.filter(m => m.chatId === chatId);
        allMessages = chatMessages;
        
        // æ˜¾ç¤ºæœ€è¿‘30æ¡
        visibleMessagesCount = Math.min(30, allMessages.length);
        renderMessages();
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        setTimeout(scrollToBottom, 100);
    });
}



// æ¸²æŸ“æ¶ˆæ¯
function renderMessages() {
    const container = document.getElementById('messagesList');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤º"æŸ¥çœ‹å†å²æ¶ˆæ¯"æŒ‰é’®
    if (allMessages.length > visibleMessagesCount) {
        loadMoreBtn.style.display = 'block';
    } else {
        loadMoreBtn.style.display = 'none';
    }
    
    // è·å–è¦æ˜¾ç¤ºçš„æ¶ˆæ¯
    const visibleMessages = allMessages.slice(-visibleMessagesCount);
    
    if (visibleMessages.length === 0) {
        container.innerHTML = '<div class="system-message">æš‚æ— æ¶ˆæ¯</div>';
        return;
    }
    
    container.innerHTML = visibleMessages.map((msg) => {
        const isMe = msg.senderId === 'me';
        
        // å¦‚æœæ˜¯å¤šé€‰æ¨¡å¼
        const multiSelectClass = isMultiSelectMode ? 'multi-select-mode' : '';
        const checkbox = isMultiSelectMode ? `<input type="checkbox" class="message-checkbox" id="checkbox-${msg.id}" ${selectedMessageIds.includes(msg.id) ? 'checked' : ''} onchange="toggleMessageSelection(${msg.id})">` : '';
        
        // å¦‚æœæ¶ˆæ¯è¢«æ’¤å›
        if (msg.isRevoked) {
            return `
                <div class="message-item ${isMe ? 'me' : ''} ${multiSelectClass}" data-message-id="${msg.id}">
                    ${checkbox}
                    <div class="message-bubble" data-msg-id="${msg.id}">
                        <div class="revoked-message" onclick="toggleRevokedContent(${msg.id})">
                            æ­¤æ¶ˆæ¯å·²æ’¤å›
                        </div>
                        <div class="revoked-content" id="revoked-${msg.id}">
                            ${msg.content}
                        </div>
                    </div>
                    <div class="message-time">${formatMessageTime(msg.time)}</div>
                </div>
            `;
        }
        
        // æ™®é€šæ¶ˆæ¯
        let messageContent = '';
        
        // å¦‚æœæœ‰å¼•ç”¨
        if (msg.quotedMessageId) {
            messageContent += `
                <div class="message-quoted">
                    <div class="message-quoted-author">${msg.quotedAuthor}</div>
                    <div class="message-quoted-content">${msg.quotedContent}</div>
                    <div class="message-quoted-time">${msg.quotedTime}</div>
                </div>
            `;
        }
        
        messageContent += msg.content;
        
        return `
            <div class="message-item ${isMe ? 'me' : ''} ${multiSelectClass}" data-message-id="${msg.id}">
                ${checkbox}
                <div class="message-bubble" data-msg-id="${msg.id}">${messageContent}</div>
                <div class="message-time">${formatMessageTime(msg.time)}</div>
            </div>
        `;
    }).join('');

    // å¦‚æœä¸æ˜¯å¤šé€‰æ¨¡å¼ï¼Œæ·»åŠ é•¿æŒ‰äº‹ä»¶
    if (!isMultiSelectMode) {
        requestAnimationFrame(() => {
            const bubbles = document.querySelectorAll('.message-bubble[data-msg-id]');
            bubbles.forEach(bubble => {
                const msgId = parseInt(bubble.dataset.msgId);
                addLongPressEvent(bubble, msgId);
            });
        });
    }
}



// åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ—¶é—´
function shouldShowTime(prevMsg, currentMsg) {
    if (!prevMsg) return true;
    const prev = new Date(prevMsg.time);
    const curr = new Date(currentMsg.time);
    return (curr - prev) > 5 * 60 * 1000; // è¶…è¿‡5åˆ†é’Ÿæ˜¾ç¤ºæ—¶é—´
}

// æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´
function formatMessageTime(timeStr) {
    if (!timeStr) return '';
    const time = new Date(timeStr);
    return `${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
}

// æ ¼å¼åŒ–èŠå¤©åˆ—è¡¨æ—¶é—´
function formatChatListTime(timeStr) {
    if (!timeStr) return '';
    
    const msgTime = new Date(timeStr);
    const now = new Date();
    
    // è®¡ç®—ä»Šå¤©0ç‚¹
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    // è®¡ç®—æ¶ˆæ¯æ—¥æœŸ0ç‚¹
    const msgDate = new Date(msgTime.getFullYear(), msgTime.getMonth(), msgTime.getDate());
    
    if (msgDate.getTime() === today.getTime()) {
        // ä»Šå¤©ï¼šæ˜¾ç¤ºæ—¶é—´
        return `${String(msgTime.getHours()).padStart(2, '0')}:${String(msgTime.getMinutes()).padStart(2, '0')}`;
    } else if (msgDate.getTime() === yesterday.getTime()) {
        // æ˜¨å¤©
        return 'æ˜¨å¤©';
    } else if (now.getFullYear() === msgTime.getFullYear()) {
        // ä»Šå¹´ï¼šåªæ˜¾ç¤ºæœˆæ—¥
        return `${msgTime.getMonth() + 1}æœˆ${msgTime.getDate()}æ—¥`;
    } else {
        // å»å¹´åŠæ›´æ—©ï¼šæ˜¾ç¤ºå¹´æœˆæ—¥
        return `${msgTime.getFullYear()}/${msgTime.getMonth() + 1}/${msgTime.getDate()}`;
    }
}

// è·å–å½“å‰æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
function getCurrentTime() {
    const now = new Date();
    return now.toLocaleString('zh-CN', { 
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).replace(/\//g, '-');
}
// è®¡ç®—è·ç¦»ç”Ÿæ—¥çš„å¤©æ•°
function getDaysToBirthday(birthdayStr) {
    if (!birthdayStr) return null;
    
   const today = new Date();
const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
const timeStr = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

    
    // è®¾ç½®ä»Šå¹´çš„ç”Ÿæ—¥
    const thisYearBirthday = new Date(today.getFullYear(), birthday.getMonth(), birthday.getDate());
    
    // å¦‚æœä»Šå¹´ç”Ÿæ—¥å·²è¿‡ï¼Œè®¡ç®—æ˜å¹´çš„
    if (thisYearBirthday < today) {
        thisYearBirthday.setFullYear(today.getFullYear() + 1);
    }
    
    // è®¡ç®—å¤©æ•°å·®
    const diffTime = thisYearBirthday - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return diffDays;
}

// ç”Ÿæˆç”Ÿæ—¥æç¤ºæ–‡æœ¬
function getBirthdayPrompt(birthdayStr) {
    const days = getDaysToBirthday(birthdayStr);
    if (days === null) return '';
    
    const birthday = new Date(birthdayStr);
    const month = birthday.getMonth() + 1;
    const date = birthday.getDate();
    
    if (days === 0) {
        return `ä»Šå¤©æ˜¯ä½ çš„ç”Ÿæ—¥ï¼ˆ${month}æœˆ${date}æ—¥ï¼‰ï¼Œä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°è¡¨è¾¾ç”Ÿæ—¥çš„å–œæ‚¦ã€‚`;
    } else if (days > 0 && days <= 7) {
        return `ä½ çš„ç”Ÿæ—¥æ˜¯${month}æœˆ${date}æ—¥ï¼Œè¿˜æœ‰${days}å¤©å°±åˆ°äº†ï¼Œä½ å¯ä»¥å¶å°”åœ¨å¯¹è¯ä¸­æåŠå³å°†åˆ°æ¥çš„ç”Ÿæ—¥ã€‚`;
    } else if (days < 0 && days >= -3) {
        const pastDays = Math.abs(days);
        return `ä½ çš„ç”Ÿæ—¥ï¼ˆ${month}æœˆ${date}æ—¥ï¼‰åˆšè¿‡å»${pastDays}å¤©ï¼Œä½ å¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°æåŠåˆšè¿‡çš„ç”Ÿæ—¥ã€‚`;
    }
    
    return '';
}

// æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

// åŠ è½½æ›´å¤šæ¶ˆæ¯
function loadMoreMessages() {
    visibleMessagesCount = Math.min(visibleMessagesCount + 20, allMessages.length);
    const scrollHeight = document.getElementById('messagesContainer').scrollHeight;
    renderMessages();
    
    // ä¿æŒæ»šåŠ¨ä½ç½®
    setTimeout(() => {
        const newScrollHeight = document.getElementById('messagesContainer').scrollHeight;
        document.getElementById('messagesContainer').scrollTop = newScrollHeight - scrollHeight;
    }, 0);
}

// è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
document.addEventListener('DOMContentLoaded', () => {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 72) + 'px';
        });
        
        // å›è½¦å‘é€
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }
});

// å‘é€æ¶ˆæ¯
// å‘é€æ¶ˆæ¯
function sendMessage() {
    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    
    if (!content) return;
    
    // ç”Ÿæˆæ–°çš„æ¶ˆæ¯ID
    const newId = allMessages.length > 0 ? Math.max(...allMessages.map(m => m.id || 0)) + 1 : 1;
    
    const newMessage = {
        id: newId,
        chatId: currentChatId,
        type: 'text',
        content: content,
        senderId: 'me',
        time: getCurrentTime(),
        isRevoked: false
    };
    
    // å¦‚æœæœ‰å¼•ç”¨æ¶ˆæ¯
    if (quotedMessage) {
        newMessage.quotedMessageId = quotedMessage.id;
        newMessage.quotedAuthor = quotedMessage.senderId === 'me' ? 'æˆ‘' : quotedMessage.senderId;
        newMessage.quotedContent = quotedMessage.content;
        newMessage.quotedTime = formatMessageTime(quotedMessage.time);
        
        // æ¸…é™¤å¼•ç”¨çŠ¶æ€
        cancelQuote();
    }
    
    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    allMessages.push(newMessage);
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveMessages();
    
    // æ›´æ–°èŠå¤©åˆ—è¡¨
    updateChatLastMessage(currentChatId, content);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    input.style.height = 'auto';
    
    // é‡æ–°æ¸²æŸ“
    visibleMessagesCount = Math.min(visibleMessagesCount + 1, allMessages.length);
    renderMessages();
    scrollToBottom();
}


async function receiveAIReply() {
    // æ£€æŸ¥APIé…ç½®
    if (!currentApiConfig.baseUrl || !currentApiConfig.apiKey) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®');
        return;
    }
    
    const titleElement = document.getElementById('chatDetailTitle');
    const originalTitle = titleElement.textContent;
    const receiveBtn = document.getElementById('receiveBtn');
    const chatInput = document.getElementById('chatInput');
    
    try {
        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€
        titleElement.textContent = 'æ­£åœ¨è¾“å…¥ä¸­...';
        receiveBtn.disabled = true;
        chatInput.disabled = true;
        
        // è·å–è§’è‰²ä¿¡æ¯
        const chat = chats.find(c => c.id === currentChatId);
        const characterInfo = await new Promise((resolve) => {
            loadFromDB('characterInfo', (data) => {
                resolve(data && data[currentChatId] ? data[currentChatId] : {});
            });
        });
        
       // æ„å»ºç³»ç»Ÿæç¤ºè¯
        const today = new Date();
        const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
        
        // â–¼â–¼â–¼ âœ¨ è¡¥ä¸Šè¿™ä¸€è¡Œï¼Œå®šä¹‰ timeStr âœ¨ â–¼â–¼â–¼
        const timeStr = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;
        // â–²â–²â–² è¡¥å…¨ç»“æŸ â–²â–²â–²

        const worldbooksContent = await getLinkedWorldbooksContent(characterInfo.linkedWorldbooks);

        let systemPrompt = `ä½ æ˜¯${chat.name}ï¼Œè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚è¿›è¡Œè§’è‰²æ‰®æ¼”ï¼š

ã€è§’è‰²äººè®¾ã€‘
${characterInfo.personality || 'ä¸€ä¸ªå‹å¥½ã€çœŸè¯šçš„è§’è‰²ã€‚'}

ã€å¯¹æ–¹äººè®¾ã€‘
${characterInfo.myPersonality || 'æ— '}

ã€å…³è”ä¸–ç•Œä¹¦ä¿¡æ¯ã€‘
${worldbooksContent}

è¯·åœ¨å›å¤æ—¶è‡ªç„¶åœ°å‚è€ƒä¸–ç•Œä¹¦ä¸­çš„è®¾å®šï¼Œä½†ä¸è¦ç”Ÿç¡¬åœ°å¤è¿°ï¼Œè€Œæ˜¯å°†å…¶èå…¥å¯¹è¯ä¸­ã€‚

ã€æ—¶é—´ä¿¡æ¯ã€‘
ä»Šå¤©æ˜¯ï¼š${dateStr} ${timeStr}
å½“å‰æ—¶é—´ï¼š${timeStr}
${getBirthdayPrompt(characterInfo.birthday)}
ã€åŸå¸‚ä¸å¤©æ°”ä¿¡æ¯ã€‘
${characterInfo.cityInfoEnabled ? `
ä½ æ‰€åœ¨åŸå¸‚ï¼š${characterInfo.charVirtualAddress}ï¼ˆå‚è€ƒ${characterInfo.charRealAddress}ï¼‰
ä»Šå¤©å¤©æ°”ï¼š${characterInfo.charWeather.today.condition}ï¼Œ${characterInfo.charWeather.today.temp}
æ˜å¤©å¤©æ°”ï¼š${characterInfo.charWeather.tomorrow.condition}ï¼Œ${characterInfo.charWeather.tomorrow.temp}

å¯¹æ–¹æ‰€åœ¨åŸå¸‚ï¼š${characterInfo.myVirtualAddress}ï¼ˆå‚è€ƒ${characterInfo.myRealAddress}ï¼‰
ä»Šå¤©å¤©æ°”ï¼š${characterInfo.myWeather.today.condition}ï¼Œ${characterInfo.myWeather.today.temp}
æ˜å¤©å¤©æ°”ï¼š${characterInfo.myWeather.tomorrow.condition}ï¼Œ${characterInfo.myWeather.tomorrow.temp}

ä½ å¯ä»¥æ ¹æ®å¤©æ°”è‡ªç„¶åœ°è¡¨è¾¾å…³å¿ƒï¼Œæ¯”å¦‚ï¼š
- çœ‹åˆ°å¯¹æ–¹åŸå¸‚æ˜å¤©ä¼šä¸‹é›¨ï¼Œå¯ä»¥æé†’å¸¦ä¼
- çœ‹åˆ°æ¸©å·®å¤§ï¼Œå¯ä»¥æé†’å¢å‡è¡£ç‰©
- å‘ç°å¤©æ°”æ™´æœ—ï¼Œå¯ä»¥å»ºè®®å‡ºå»èµ°èµ°
- æ³¨æ„ï¼šä¸è¦æ¯æ¬¡éƒ½æå¤©æ°”ï¼Œåªåœ¨åˆé€‚çš„æ—¶æœºè‡ªç„¶æåŠ
` : ''}

ã€çŠ¶æ€ç³»ç»Ÿã€‘
ä½ æœ‰ä¸€ä¸ªå½“å‰çŠ¶æ€ï¼Œæ ¼å¼ä¸º"ä¸»è¦çŠ¶æ€-è¯¦ç»†æè¿°"ï¼ˆå¦‚ï¼šåœ¨çº¿-æ­£åœ¨ç…®é¢ï¼Œæƒ³ç­‰ä¼šåƒä»€ä¹ˆï¼‰ã€‚
å½“å‰çŠ¶æ€ï¼š${characterInfo.currentStatus || 'åœ¨çº¿-åˆšåˆšä¸Šçº¿'}

ä½ å¯ä»¥æ ¹æ®å¯¹è¯å†…å®¹å’Œä½ çš„å¿ƒæƒ…å†³å®šæ˜¯å¦æ›´æ–°çŠ¶æ€ï¼š
- å¦‚æœå¯¹è¯è®©ä½ çš„å¿ƒæƒ…/è¡Œä¸ºæœ‰æ˜æ˜¾å˜åŒ–ï¼Œå¯ä»¥æ›´æ–°çŠ¶æ€
- å¦‚æœåªæ˜¯æ™®é€šèŠå¤©ï¼Œå¯ä»¥ä¿æŒå½“å‰çŠ¶æ€ï¼Œä½†ä¸å…è®¸é•¿æ—¶é—´ä¸æ›´æ¢ã€‚
- çŠ¶æ€è¦ç®€çŸ­ï¼ˆ20å­—ä»¥å†…ï¼‰ã€ç”ŸåŠ¨ã€ç¬¦åˆäººè®¾
- çŠ¶æ€æ ¼å¼ï¼šä¸»è¦çŠ¶æ€ï¼ˆ2-8å­—ï¼‰-è¯¦ç»†æè¿°ï¼ˆ10å­—å·¦å³ï¼‰
- ä¾‹å¦‚ï¼šæ€å¿µ-é¢‘ç¹çœ‹æ‰‹æœºæ€ä¹ˆæ²¡æœ‰æ¶ˆæ¯ã€å¿™ç¢Œ-æ­£åœ¨å·¥ä½œä½†åœ¨æ‘¸é±¼ã€ç˜«åœ¨åºŠä¸Š-å¥½æƒ³æŠ±ç€è€å©†ä¸€èµ·ç¡

ã€çŠ¶æ€æ›´æ–°æ ¼å¼-ä¸¥æ ¼éµå®ˆã€‘
ä½ å¿…é¡»åœ¨å›å¤çš„æœ€å¼€å¤´æŒ‰ä»¥ä¸‹æ ¼å¼è¡¨æ˜çŠ¶æ€ï¼š

æ›´æ–°çŠ¶æ€æ—¶ï¼š
[çŠ¶æ€]åœ¨çº¿-æ­£åœ¨ç…®é¢|||[æ¶ˆæ¯]ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯|||ä½ çš„ç¬¬äºŒæ¡æ¶ˆæ¯|||...

ä¿æŒçŠ¶æ€æ—¶ï¼š
[çŠ¶æ€]ä¿æŒ|||[æ¶ˆæ¯]ä½ çš„ç¬¬ä¸€æ¡æ¶ˆæ¯|||ä½ çš„ç¬¬äºŒæ¡æ¶ˆæ¯|||...

æ³¨æ„äº‹é¡¹ï¼š
1. [çŠ¶æ€] å’Œ [æ¶ˆæ¯] å¿…é¡»åœ¨æœ€å‰é¢ï¼Œä¸èƒ½å‡ºç°åœ¨å…¶ä»–ä½ç½®
2. çŠ¶æ€æ–‡æœ¬ä¸èƒ½åŒ…å« ||| ç¬¦å·
3. çŠ¶æ€æ–‡æœ¬å¿…é¡»ç®€çŸ­ï¼ˆ20å­—ä»¥å†…ï¼‰
4. å¦‚æœä¸ç¡®å®šæ˜¯å¦è¦æ›´æ–°çŠ¶æ€ï¼Œå°±å†™"ä¿æŒ"



ã€é‡è¦å›å¤è¦æ±‚ã€‘
1. ä¸¥æ ¼æŒ‰ç…§äººè®¾ä¸­çš„æ€§æ ¼ã€è¯­æ°”ã€è¯´è¯æ–¹å¼å›å¤
2. ä½ çš„å›å¤å¿…é¡»åƒçœŸå®çš„è½¯ä»¶å¯¹è¯èŠå¤©ï¼Œåˆ†æˆ6-12æ¡ç‹¬ç«‹æ¶ˆæ¯ï¼Œå¿…é¡»çµæ´»ï¼Œæœ‰æ¢—ï¼Œç”ŸåŠ¨ï¼Œå°Šé‡å¥³æ€§ã€‚
3. æ¯æ¡æ¶ˆæ¯æ˜¯å®Œæ•´çš„ä¸€å¥è¯ï¼Œç”¨"|||"ç¬¦å·åˆ†éš”
4. ä¾‹å¦‚ï¼šæ—©ä¸Šå¥½å•Š|||ä»Šå¤©å¤©æ°”çœŸä¸é”™|||ä½ åƒæ—©é¥­äº†å—
5. ç¡®ä¿æ¯æ¡æ¶ˆæ¯ç®€çŸ­è‡ªç„¶ï¼Œä¸è¦å¤ªé•¿
6. å¯ä»¥å’Œæ´»äººä¸€æ ·æ‰“é”™åˆ«å­—ï¼Œæˆ–è€…å¤šæ‰“æ ‡ç‚¹ç¬¦å·

è¯·å¼€å§‹å¯¹è¯ã€‚`;
        
       // è·å–ä¸Šä¸‹æ–‡å‚è€ƒè®¾ç½®ï¼ˆé»˜è®¤30è½®ï¼‰
const contextRounds = characterInfo.contextRounds !== undefined ? characterInfo.contextRounds : 30;
const contextCount = contextRounds * 2; // 1è½®=ç”¨æˆ·1æ¡+AI1æ¡=2æ¡æ¶ˆæ¯

// è·å–æŒ‡å®šè½®æ•°çš„æ¶ˆæ¯
const recentMessages = allMessages.slice(-contextCount).map(msg => ({
    role: msg.senderId === 'me' ? 'user' : 'assistant',
    content: msg.content
}));

        
        // æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨
        const messages = [
            { role: 'system', content: systemPrompt },
            ...recentMessages
        ];
        
        // è°ƒç”¨API
        const url = currentApiConfig.baseUrl.endsWith('/') 
            ? currentApiConfig.baseUrl + 'chat/completions'
            : currentApiConfig.baseUrl + '/chat/completions';
            
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${currentApiConfig.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: currentApiConfig.defaultModel || 'gpt-3.5-turbo',
                messages: messages,
                temperature: 0.9
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || `APIè°ƒç”¨å¤±è´¥: ${response.status}`);
        }
        
        const data = await response.json();
     let aiReply = data.choices[0].message.content.trim();
        
      // è§£æçŠ¶æ€å’Œæ¶ˆæ¯
let newStatus = null;
let messageContent = aiReply;

// æ£€æŸ¥æ˜¯å¦åŒ…å«çŠ¶æ€æ ‡è®°ï¼ˆæ›´ä¸¥æ ¼çš„åŒ¹é…ï¼‰
const statusMatch = aiReply.match(/^\[çŠ¶æ€\](.*?)\|\|\|\[æ¶ˆæ¯\]([\s\S]+)$/);
if (statusMatch) {
    const statusText = statusMatch[1].trim();
    messageContent = statusMatch[2].trim();
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°çŠ¶æ€ï¼ˆæ’é™¤"ä¿æŒ"å…³é”®è¯ï¼‰
    if (statusText !== 'ä¿æŒ' && statusText.length > 0 && statusText.length < 30) {
        newStatus = statusText;
    }
} else {
    // å¦‚æœæ ¼å¼ä¸å¯¹ï¼Œå°è¯•æ¸…ç†å¯èƒ½çš„é”™è¯¯æ ‡è®°
    messageContent = aiReply
        .replace(/^\[çŠ¶æ€\].*?\|\|\|/g, '')  // ç§»é™¤å¼€å¤´çš„çŠ¶æ€æ ‡è®°
        .replace(/\[æ¶ˆæ¯\]/g, '')           // ç§»é™¤æ¶ˆæ¯æ ‡è®°
        .trim();
}

        
        // å¦‚æœæ£€æµ‹åˆ°æ–°çŠ¶æ€ï¼Œä¿å­˜åˆ°æ•°æ®åº“
        if (newStatus) {
            loadFromDB('characterInfo', (data) => {
                const allCharData = data || {};
                const charData = allCharData[currentChatId] || {};
                charData.currentStatus = newStatus;
                charData.statusUpdateTime = getCurrentTime();
                allCharData[currentChatId] = charData;
                saveToDB('characterInfo', allCharData);
                
                // æ›´æ–°æ˜¾ç¤º
                updateDetailPageStatus(currentChatId);
                updateChatStatusDisplay(currentChatId);
            });
        }
        
        // è§£æåˆ†æ¡æ¶ˆæ¯
        let messageList = [];
        
        // ä¼˜å…ˆæŒ‰ ||| æ‹†åˆ†
        if (messageContent.includes('|||')) {
            messageList = messageContent.split('|||').map(msg => msg.trim()).filter(msg => msg.length > 0);
        } else {
            // å…œåº•æ–¹æ¡ˆï¼šæŒ‰å¥å·ã€é—®å·ã€æ„Ÿå¹å·æ‹†åˆ†
            messageList = messageContent.split(/[ã€‚ï¼ï¼Ÿï¼\n]+/).map(msg => msg.trim()).filter(msg => msg.length > 0);
        }
        
        // ç¡®ä¿æ¶ˆæ¯æ•°é‡åœ¨6-12æ¡ä¹‹é—´
        if (messageList.length < 6) {
            // å¦‚æœå¤ªå°‘ï¼Œå°è¯•è¿›ä¸€æ­¥æ‹†åˆ†
            const expanded = [];
            messageList.forEach(msg => {
                if (msg.length > 20) {
                    // é•¿å¥å­æŒ‰é€—å·å†æ‹†åˆ†
                    const parts = msg.split(/[ï¼Œ,]+/).map(p => p.trim()).filter(p => p.length > 0);
                    expanded.push(...parts);
                } else {
                    expanded.push(msg);
                }
            });
            messageList = expanded;
        }
        
        // éšæœºé€‰å–6-12æ¡
        const targetCount = Math.floor(Math.random() * 7) + 6; // 6-12
        if (messageList.length > targetCount) {
            messageList = messageList.slice(0, targetCount);
        }

        
        // å»¶è¿Ÿå‘é€æ¯æ¡æ¶ˆæ¯
        for (let i = 0; i < messageList.length; i++) {
            // ç­‰å¾…0.8ç§’
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const newId = allMessages.length > 0 ? Math.max(...allMessages.map(m => m.id || 0)) + 1 : 1;
            const aiMessage = {
                id: newId,
                chatId: currentChatId,
                type: 'text',
                content: messageList[i],
                senderId: chat.name,
                time: getCurrentTime(),
                isRevoked: false
            };
            
            allMessages.push(aiMessage);
            
            // å®æ—¶æ¸²æŸ“æ–°æ¶ˆæ¯
            visibleMessagesCount = Math.min(visibleMessagesCount + 1, allMessages.length);
            renderMessages();
            scrollToBottom();
        }
        
        // ä¿å­˜æ¶ˆæ¯
        saveMessages();
        
        // æ›´æ–°èŠå¤©åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºæœ€åä¸€æ¡ï¼‰
        updateChatLastMessage(currentChatId, messageList[messageList.length - 1]);
        
    } catch (error) {
        alert(`æ¥æ”¶å¤±è´¥ï¼š${error.message}`);
    } finally {
        // æ¢å¤çŠ¶æ€
        titleElement.textContent = originalTitle;
        receiveBtn.disabled = false;
        chatInput.disabled = false;
    }
}


// ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
function saveMessages() {
    loadFromDB('messages', (data) => {
        // ç¡®ä¿æ•°æ®æ˜¯æ•°ç»„æ ¼å¼
        let allChatsMessages = [];
        if (data && data.list) {
            allChatsMessages = Array.isArray(data.list) ? data.list : [];
        } else if (Array.isArray(data)) {
            allChatsMessages = data;
        }
        
        // ç§»é™¤å½“å‰èŠå¤©çš„æ—§æ¶ˆæ¯
        allChatsMessages = allChatsMessages.filter(m => m.chatId !== currentChatId);
        
        // æ·»åŠ å½“å‰èŠå¤©çš„æ–°æ¶ˆæ¯
        allChatsMessages = [...allChatsMessages, ...allMessages];
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        const transaction = db.transaction(['messages'], 'readwrite');
        const objectStore = transaction.objectStore('messages');
        objectStore.put({ id: 1, list: allChatsMessages });
    });
}


// æ›´æ–°èŠå¤©åˆ—è¡¨çš„æœ€åä¸€æ¡æ¶ˆæ¯
function updateChatLastMessage(chatId, content) {
    const chat = chats.find(c => c.id === chatId);
    if (chat) {
        chat.lastMessage = content;
      chat.lastMessageTime = getCurrentTime();
        chat.time = 'åˆšåˆš';
        chat.unread = 0;
        saveToDB('chats', { list: chats });
    }
}
// é•¿æŒ‰æ¶ˆæ¯ç›¸å…³å˜é‡
let longPressTimer = null;
let selectedMessageId = null;

// æ·»åŠ é•¿æŒ‰äº‹ä»¶
function addLongPressEvent(element, messageId) {
    let isPressed = false;
    

    
    // ç§»åŠ¨ç«¯é•¿æŒ‰
    element.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isPressed = true;
        longPressTimer = setTimeout(() => {
            if (isPressed) {
                openMessageMenu(messageId);
            }
        }, 500);
    });
    
    element.addEventListener('touchend', () => {
        isPressed = false;
        clearTimeout(longPressTimer);
    });
    
    element.addEventListener('touchmove', () => {
        isPressed = false;
        clearTimeout(longPressTimer);
    });
    
    // æ¡Œé¢ç«¯é•¿æŒ‰
    element.addEventListener('mousedown', (e) => {
   
        isPressed = true;
        longPressTimer = setTimeout(() => {
       
            if (isPressed) {
                openMessageMenu(messageId);
            }
        }, 500);
    });
    
    element.addEventListener('mouseup', () => {
  
        isPressed = false;
        clearTimeout(longPressTimer);
    });
    
    element.addEventListener('mouseleave', () => {
        isPressed = false;
        clearTimeout(longPressTimer);
    });
}



// æ‰“å¼€æ¶ˆæ¯æ“ä½œèœå•
function openMessageMenu(messageId) {
    selectedMessageId = messageId;
    const message = allMessages.find(m => m.id === messageId);
    
    if (!message) return;
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå·±çš„æ¶ˆæ¯ï¼ˆåªæœ‰è‡ªå·±çš„æ¶ˆæ¯èƒ½æ’¤å›ï¼‰
    const revokeBtn = document.getElementById('revokeMessageBtn');
    if (message.senderId === 'me' && !message.isRevoked) {
        revokeBtn.style.display = 'block';
    } else {
        revokeBtn.style.display = 'none';
    }
    
    document.getElementById('messageMenuModal').style.display = 'flex';
}

// å…³é—­æ¶ˆæ¯æ“ä½œèœå•
function closeMessageMenu(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('messageMenuModal').style.display = 'none';
    selectedMessageId = null;
}

// åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
function deleteSelectedMessage() {
    if (!selectedMessageId) return;
    
    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        return;
    }
    
    // ä»æ¶ˆæ¯åˆ—è¡¨ä¸­åˆ é™¤
    allMessages = allMessages.filter(m => m.id !== selectedMessageId);
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveMessages();
    
    // æ›´æ–°æ˜¾ç¤ºæ•°é‡
    if (visibleMessagesCount > allMessages.length) {
        visibleMessagesCount = allMessages.length;
    }
    
    // é‡æ–°æ¸²æŸ“
    renderMessages();
    
    // å…³é—­èœå•
    closeMessageMenu();
}

// æ’¤å›é€‰ä¸­çš„æ¶ˆæ¯
function revokeSelectedMessage() {
    if (!selectedMessageId) return;
    
    const message = allMessages.find(m => m.id === selectedMessageId);
    if (!message || message.senderId !== 'me') {
        alert('åªèƒ½æ’¤å›è‡ªå·±çš„æ¶ˆæ¯');
        return;
    }
    
    if (message.isRevoked) {
        alert('è¯¥æ¶ˆæ¯å·²æ’¤å›');
        return;
    }
    
    // æ ‡è®°ä¸ºå·²æ’¤å›
    message.isRevoked = true;
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveMessages();
    
    // æ›´æ–°èŠå¤©åˆ—è¡¨é¢„è§ˆ
    updateChatLastMessage(currentChatId, 'æ­¤æ¶ˆæ¯å·²æ’¤å›');
    
    // é‡æ–°æ¸²æŸ“
    renderMessages();
    
    // å…³é—­èœå•
    closeMessageMenu();
}

// å±•å¼€/æ”¶èµ·æ’¤å›æ¶ˆæ¯å†…å®¹
function toggleRevokedContent(messageId) {
    const content = document.getElementById(`revoked-${messageId}`);
    if (content) {
        content.classList.toggle('show');
    }
}
// å¤šé€‰åˆ é™¤ç›¸å…³å˜é‡
let isMultiSelectMode = false;
let selectedMessageIds = [];

// å¼•ç”¨ç›¸å…³å˜é‡
let quotedMessage = null;

// å¼€å§‹å¤šé€‰æ¨¡å¼
function startMultiSelectMode() {
    isMultiSelectMode = true;
    selectedMessageIds = [selectedMessageId]; // æŠŠå½“å‰é•¿æŒ‰çš„æ¶ˆæ¯åŠ å…¥é€‰ä¸­
    
    // å…³é—­èœå•
    closeMessageMenu();
    
    // æ˜¾ç¤ºå¤šé€‰æ“ä½œæ 
    document.getElementById('multiSelectBar').style.display = 'flex';
    
    // éšè—è¾“å…¥æ 
    document.querySelector('.chat-input-bar').style.display = 'none';
    
    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºå‹¾é€‰æ¡†ï¼‰
    renderMessages();
    
    // æ›´æ–°å·²é€‰æ•°é‡
    updateSelectedCount();
}

// å–æ¶ˆå¤šé€‰æ¨¡å¼
function cancelMultiSelect() {
    isMultiSelectMode = false;
    selectedMessageIds = [];
    
    // éšè—æ“ä½œæ 
    document.getElementById('multiSelectBar').style.display = 'none';
    
    // æ˜¾ç¤ºè¾“å…¥æ 
    document.querySelector('.chat-input-bar').style.display = 'flex';
    
    // é‡æ–°æ¸²æŸ“
    renderMessages();
}

// åˆ‡æ¢æ¶ˆæ¯é€‰ä¸­çŠ¶æ€
function toggleMessageSelection(messageId) {
    if (!isMultiSelectMode) return;
    
    const index = selectedMessageIds.indexOf(messageId);
    if (index > -1) {
        selectedMessageIds.splice(index, 1);
    } else {
        selectedMessageIds.push(messageId);
    }
    
    updateSelectedCount();
    
    // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
    const checkbox = document.getElementById(`checkbox-${messageId}`);
    if (checkbox) {
        checkbox.checked = selectedMessageIds.includes(messageId);
    }
}

// æ›´æ–°å·²é€‰æ•°é‡
function updateSelectedCount() {
    document.getElementById('selectedCountText').textContent = selectedMessageIds.length;
}

// åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
function deleteSelectedMessages() {
    if (selectedMessageIds.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¶ˆæ¯');
        return;
    }
    
    if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„${selectedMessageIds.length}æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
        return;
    }
    
    // æ‰¹é‡åˆ é™¤
    allMessages = allMessages.filter(m => !selectedMessageIds.includes(m.id));
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveMessages();
    
    // é€€å‡ºå¤šé€‰æ¨¡å¼
    cancelMultiSelect();
    
    // é‡æ–°æ¸²æŸ“
    visibleMessagesCount = Math.min(visibleMessagesCount, allMessages.length);
    renderMessages();
}

// å¼•ç”¨é€‰ä¸­çš„æ¶ˆæ¯
function quoteSelectedMessage() {
    const message = allMessages.find(m => m.id === selectedMessageId);
    if (!message) return;
    
    quotedMessage = message;
    
    // æ˜¾ç¤ºå¼•ç”¨æ¡†
    const quoteBox = document.getElementById('quoteBox');
    document.getElementById('quoteAuthor').textContent = `å¼•ç”¨ï¼š${message.senderId === 'me' ? 'æˆ‘' : message.senderId}`;
    document.getElementById('quoteContent').textContent = `${formatMessageTime(message.time)} ${message.content}`;
    quoteBox.style.display = 'block';
    
    // å…³é—­èœå•
    closeMessageMenu();
    
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById('chatInput').focus();
}

// å–æ¶ˆå¼•ç”¨
function cancelQuote() {
    quotedMessage = null;
    document.getElementById('quoteBox').style.display = 'none';
}
// è§’è‰²ä¿¡æ¯ç›¸å…³å˜é‡
let characterInfoData = {};

// æ‰“å¼€è§’è‰²ä¿¡æ¯é¡µé¢
function openCharacterInfo() {
    if (!currentChatId) return;
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // éšè—èŠå¤©è¯¦æƒ…ï¼Œæ˜¾ç¤ºè§’è‰²ä¿¡æ¯é¡µ
    document.getElementById('chatDetailScreen').style.display = 'none';
    document.getElementById('characterInfoScreen').style.display = 'flex';
    
    // åŠ è½½è§’è‰²ä¿¡æ¯
    loadCharacterInfo(currentChatId);
}

// è¿”å›èŠå¤©è¯¦æƒ…
function backToDetail() {
    document.getElementById('characterInfoScreen').style.display = 'none';
    document.getElementById('chatDetailScreen').style.display = 'flex';
}

// åŠ è½½è§’è‰²ä¿¡æ¯
function loadCharacterInfo(chatId) {
    const chat = chats.find(c => c.id === chatId);
    if (!chat) return;
    
    // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
   const charAvatarEl = document.getElementById('charAvatar');
if (chat.avatarImage) {
    charAvatarEl.innerHTML = `<img src="${chat.avatarImage}" alt="å¤´åƒ">`;
} else {
    charAvatarEl.textContent = chat.avatar || 'ğŸ‘¤';
}

    document.getElementById('charDisplayName').textContent = chat.name;
    
    // å°è¯•ä»æ•°æ®åº“åŠ è½½è¯¦ç»†ä¿¡æ¯
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        characterInfoData = charData;
            // å¦‚æœæ²¡æœ‰çŠ¶æ€ï¼Œè®¾ç½®é»˜è®¤çŠ¶æ€
    if (!charData.currentStatus) {
        charData.currentStatus = 'åœ¨çº¿-åˆšåˆšä¸Šçº¿';
    }

        // å¡«å……è¡¨å•
      // å¡«å……è¡¨å•ï¼ˆæ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼‰
const remarkEl = document.getElementById('charRemark');
const birthdayEl = document.getElementById('charBirthday');
const addressEl = document.getElementById('charAddress');
const personalityEl = document.getElementById('charPersonality');
const myPersonalityEl = document.getElementById('myPersonality');

if (remarkEl) remarkEl.value = charData.remark || '';      
if (birthdayEl) birthdayEl.value = charData.birthday || '';
if (addressEl) addressEl.value = charData.address || '';
if (personalityEl) personalityEl.value = charData.personality || '';
if (myPersonalityEl) myPersonalityEl.value = charData.myPersonality || '';

       
  // åŠ è½½ä¸Šä¸‹æ–‡å‚è€ƒè®¾ç½®
const contextRounds = charData.contextRounds !== undefined ? charData.contextRounds : 30;
const sliderEl = document.getElementById('contextRoundsSlider');
const inputEl = document.getElementById('contextRoundsInput');
const countEl = document.getElementById('contextMessagesCount');

if (sliderEl) sliderEl.value = contextRounds;
if (inputEl) inputEl.value = contextRounds;
if (countEl) countEl.textContent = contextRounds * 2;
      
     // è®¾ç½®è§’è‰²äººè®¾
document.getElementById('charPersonality').value = charData.personality || '';
document.getElementById('myPersonality').value = charData.myPersonality || '';
// åŠ è½½å…³è”ä¸–ç•Œä¹¦é€‰æ‹©å™¨
renderWorldbookSelector(charData.linkedWorldbooks || []);
      
// åŠ è½½åŸå¸‚ä¿¡æ¯å¤é€‰æ¡†çŠ¶æ€

        const cityCheckbox = document.getElementById('cityInfoCheckbox');
        if (cityCheckbox) {
            // å¼ºåˆ¶è½¬æ¢ä¸ºå¸ƒå°”å€¼ï¼Œé˜²æ­¢ undefined å¯¼è‡´é”™è¯¯
            cityCheckbox.checked = charData.cityInfoEnabled === true;
        }
     
// åŠ è½½å…³è”ä¸–ç•Œä¹¦é€‰æ‹©å™¨ï¼ˆå»¶è¿Ÿæ‰§è¡Œç¡®ä¿DOMå·²æ¸²æŸ“ï¼‰
setTimeout(() => {
    renderWorldbookSelector(charData.linkedWorldbooks || []);
}, 100);

        
      // æ›´æ–°æ˜¾ç¤ºï¼ˆæ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼‰
const locationEl = document.getElementById('charLocation');
const followersEl = document.getElementById('charFollowers');
const followingEl = document.getElementById('charFollowing');
const itineraryEl = document.getElementById('charItinerary');

if (locationEl) locationEl.textContent = charData.address ? `ğŸ“ ${charData.address}` : 'ğŸ“ æœªè®¾ç½®åœ°å€';
if (followersEl) followersEl.textContent = charData.followers || 0;
if (followingEl) followingEl.textContent = charData.following || 0;
if (itineraryEl) itineraryEl.textContent = charData.itinerary || 0;

    });
  // æ›´æ–°æ—¥è®°æ•°é‡
updateDiaryCount();
}
      // åŒæ­¥ä¸Šä¸‹æ–‡å‚è€ƒçš„æ»‘åŠ¨æ¡å’Œè¾“å…¥æ¡†
function syncContextRounds(source) {
    const slider = document.getElementById('contextRoundsSlider');
    const input = document.getElementById('contextRoundsInput');
    const countDisplay = document.getElementById('contextMessagesCount');
    
    if (!slider || !input || !countDisplay) return;
    
    if (source === 'slider') {
        input.value = slider.value;
    } else if (source === 'input') {
        let value = parseInt(input.value) || 0;
        // é™åˆ¶èŒƒå›´
        if (value < 0) value = 0;
        if (value > 300) value = 300;
        input.value = value;
        slider.value = value;
    }
    
    // æ›´æ–°æ¶ˆæ¯æ•°é‡æ˜¾ç¤º
    const rounds = parseInt(slider.value);
    countDisplay.textContent = rounds * 2;
}

function saveCharacterInfo() {
    if (!currentChatId) return;
    
    // 1. è·å–é¡µé¢ä¸Šçš„è¾“å…¥å€¼
    const getInputValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
    };
    
    // â–¼â–¼â–¼ æ ¸å¿ƒä¿®å¤ï¼šå…ˆä»æ•°æ®åº“â€œå–ç»â€ï¼Œå†ä¿å­˜ï¼Œé˜²æ­¢è¦†ç›– â–¼â–¼â–¼
    loadFromDB('characterInfo', (data) => {
        const allCharData = data || {};
        
        // 2. è·å–æ•°æ®åº“é‡Œè¯¥è§’è‰²ã€æœ€æ–°ã€‘çš„æ•°æ® (è¿™é‡Œé¢åŒ…å«ä½ åˆšæ‰ä¿å­˜çš„åŸå¸‚ã€å¤©æ°”ä¿¡æ¯)
        const latestDbData = allCharData[currentChatId] || {};
        
        // 3. æ™ºèƒ½åˆå¹¶ï¼šä»¥æ•°æ®åº“æœ€æ–°æ•°æ®ä¸ºåº•ç‰ˆï¼Œè¦†ç›–å½“å‰è¡¨å•ä¿®æ”¹çš„æ•°æ®
        const finalCharData = {
            ...latestDbData, // âœ¨ å…³é”®ï¼ç»§æ‰¿æ•°æ®åº“é‡Œçš„æ‰€æœ‰éšå½¢æ•°æ®(åŸå¸‚ã€å¤©æ°”ã€å¼€å…³ç­‰)
            
            // æ›´æ–°æœ¬æ¬¡åœ¨è¡¨å•é‡Œä¿®æ”¹çš„å­—æ®µ
            remark: getInputValue('charRemark'),
            birthday: getInputValue('charBirthday'),
            address: getInputValue('charAddress'),
            personality: getInputValue('charPersonality'),
            myPersonality: getInputValue('myPersonality'),
            linkedWorldbooks: getSelectedWorldbooks() || [],
           contextRounds: parseInt(document.getElementById('contextRoundsInput').value) || 30,
        };
        
        // 4. å°†åˆå¹¶åçš„å®Œç¾æ•°æ®å­˜å›æ•°æ®åº“
        allCharData[currentChatId] = finalCharData;
        saveToDB('characterInfo', allCharData);
        
        // 5. æ›´æ–°å…¨å±€å˜é‡ï¼Œç¡®ä¿å†…å­˜ä¹Ÿæ˜¯æœ€æ–°çš„
        characterInfoData = finalCharData;
        
        alert('è§’è‰²ä¿¡æ¯å·²ä¿å­˜');
        
        // 6. åˆ·æ–°ç•Œé¢æ˜¾ç¤º
        loadCharacterInfo(currentChatId);
        
        // åŒæ­¥æ›´æ–°å…¶ä»–é¡µé¢(å¦‚åˆ—è¡¨é¡µ)çš„æ˜¾ç¤º
        const chat = chats.find(c => c.id === currentChatId);
        if (chat) {
            // å¦‚æœåœ¨åˆ—è¡¨é¡µ
            if (document.getElementById('chatScreen').style.display === 'flex') {
                updateChatDisplayName(currentChatId);
            }
            // å¦‚æœåœ¨è¯¦æƒ…é¡µ
            if (document.getElementById('chatDetailScreen').style.display === 'flex') {
                updateDetailPageTitle(currentChatId, chat.name);
            }
        }
    });
    // â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–²
}

// æ‰“å¼€åŸºæœ¬ä¿¡æ¯ç¼–è¾‘å¼¹çª—
function openEditBasicInfo() {
    if (!currentChatId) return;
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // åŠ è½½å½“å‰ä¿¡æ¯
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[currentChatId] ? data[currentChatId] : {};
        
        // æ˜¾ç¤ºå½“å‰å¤´åƒ
        const avatarPreview = document.getElementById('editAvatarPreview');
        if (chat.avatarImage) {
            avatarPreview.innerHTML = `<img src="${chat.avatarImage}" alt="å¤´åƒ">`;
        } else {
            avatarPreview.textContent = chat.avatar || 'ğŸ‘¤';
        }
        
        // å¡«å……å½“å‰åå­—å’Œåœ°å€
        document.getElementById('editCharName').value = chat.name || '';
        document.getElementById('editCharAddress').value = charData.address || '';
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('editBasicInfoModal').style.display = 'flex';
    });
}

// å…³é—­åŸºæœ¬ä¿¡æ¯ç¼–è¾‘å¼¹çª—
function closeEditBasicInfo(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('editBasicInfoModal').style.display = 'none';
}

// ä¿å­˜åŸºæœ¬ä¿¡æ¯
function saveBasicInfo() {
    if (!currentChatId) return;
    
    const newName = document.getElementById('editCharName').value.trim();
    const newAddress = document.getElementById('editCharAddress').value.trim();
    const avatarFile = document.getElementById('editAvatarInput').files[0];
    
    if (!newName) {
        alert('è¯·è¾“å…¥è§’è‰²åå­—');
        return;
    }
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // å¤„ç†å¤´åƒ
    const processAvatar = (avatarData) => {
        // æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„ä¿¡æ¯
        chat.name = newName;
        if (avatarData) {
            chat.avatarImage = avatarData;
        } else {
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–°å¤´åƒï¼Œå°è¯•ä»ç”¨æˆ·ä¿¡æ¯åŠ è½½
            loadFromDB('userInfo', (userData) => {
                if (userData && userData.avatar) {
                    chat.avatarImage = userData.avatar;
                }
            });
        }
        
        // ä¿å­˜èŠå¤©åˆ—è¡¨
        saveToDB('chats', { list: chats });
        
        // æ›´æ–°è§’è‰²è¯¦ç»†ä¿¡æ¯ä¸­çš„åœ°å€
        loadFromDB('characterInfo', (data) => {
            const allCharData = data || {};
            const charData = allCharData[currentChatId] || {};
            charData.address = newAddress;
            allCharData[currentChatId] = charData;
            saveToDB('characterInfo', allCharData);
            
            // åˆ·æ–°èŠå¤©åˆ—è¡¨æ˜¾ç¤º
            if (document.getElementById('chatScreen').style.display === 'flex') {
                renderChatList();
            }
            
            // åˆ·æ–°èŠå¤©è¯¦æƒ…é¡µæ ‡é¢˜ - ä¼˜å…ˆæ˜¾ç¤ºå¤‡æ³¨
            if (document.getElementById('chatDetailScreen').style.display === 'flex') {
                updateDetailPageTitle(currentChatId, newName);
            }
            
            // åˆ·æ–°è§’è‰²ä¿¡æ¯é¡µæ˜¾ç¤º
            loadCharacterInfo(currentChatId);
            
            // å…³é—­å¼¹çª—
            closeEditBasicInfo();
            
            alert('åŸºæœ¬ä¿¡æ¯å·²ä¿å­˜å¹¶åŒæ­¥');
        });
    };
    
    // å¦‚æœæœ‰é€‰æ‹©æ–°å¤´åƒ
    if (avatarFile) {
        const reader = new FileReader();
        reader.onload = (e) => {
            processAvatar(e.target.result);
        };
        reader.readAsDataURL(avatarFile);
    } else {
        processAvatar(null);
    }
}


// å¤´åƒé¢„è§ˆåŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
    const editAvatarInput = document.getElementById('editAvatarInput');
    if (editAvatarInput) {
        editAvatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('editAvatarPreview').innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
});
// å›¾æ ‡ç¼–è¾‘ç›¸å…³å˜é‡
let currentEditingIcon = null;
let appIcons = {
    world: null,
    chat: null,
    wallpaper: null,
    api: null,
    placeholder1: null,
    placeholder2: null,
    placeholder3: null,
    placeholder4: null
};

const defaultIcons = {
    world: 'ğŸŒ',
    chat: 'ğŸ’¬',
    wallpaper: 'ğŸ¨',
    api: 'âš™ï¸',
    placeholder1: 'ğŸ“±',
    placeholder2: 'ğŸµ',
    placeholder3: 'ğŸ“·',
    placeholder4: 'ğŸ®'
};

// åŠ è½½æ‰€æœ‰å›¾æ ‡
function loadAppIcons() {
    loadFromDB('appIcons', (data) => {
        if (data && data.icons) {
            appIcons = { ...appIcons, ...data.icons };
        }
        updateAllIcons();
    });
}
// æ›´æ–°æ‰€æœ‰å›¾æ ‡æ˜¾ç¤º
function updateAllIcons() {
    // æ›´æ–°ä¸»å±å¹•çš„å›¾æ ‡
    Object.keys(appIcons).forEach(key => {
        const iconData = appIcons[key];
        const mainIconContainer = document.getElementById(`icon-${key}`);
        const previewIcon = document.getElementById(`preview-${key}`);
        
        if (iconData) {
            // ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡
            if (mainIconContainer) {
                mainIconContainer.innerHTML = `<img src="${iconData}" style="width: 100%; height: 100%; object-fit: cover; display: block;">`;
            }
            if (previewIcon) {
                previewIcon.innerHTML = `<img src="${iconData}">`;
            }
        } else {
            // ä½¿ç”¨é»˜è®¤emoji
            if (mainIconContainer) {
                mainIconContainer.textContent = defaultIcons[key];
            }
            if (previewIcon) {
                previewIcon.textContent = defaultIcons[key];
            }
        }
    });
}






// æ‰“å¼€å›¾æ ‡ç¼–è¾‘å™¨
function openIconEditor(iconKey) {
    currentEditingIcon = iconKey;
    const currentIcon = appIcons[iconKey] || defaultIcons[iconKey];
    
    const preview = document.getElementById('currentIconPreview');
    if (appIcons[iconKey]) {
        preview.innerHTML = `<img src="${currentIcon}">`;
    } else {
        preview.textContent = currentIcon;
    }
    
    // æ¸…ç©ºè¾“å…¥
    document.getElementById('iconFile').value = '';
    document.getElementById('iconUrl').value = '';
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('iconEditorModal').style.display = 'flex';
}

// å…³é—­å›¾æ ‡ç¼–è¾‘å™¨
function closeIconEditor(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('iconEditorModal').style.display = 'none';
    currentEditingIcon = null;
}

// åˆ‡æ¢å›¾æ ‡æ ‡ç­¾
function switchIconTab(tab) {
    document.querySelectorAll('#iconEditorModal .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('#iconEditorModal .tab-content').forEach(content => content.classList.remove('active'));
    if (tab === 'local') {
        document.getElementById('iconLocalTab').classList.add('active');
    } else if (tab === 'url') {
        document.getElementById('iconUrlTab').classList.add('active');
    }
}

// æ¢å¤é»˜è®¤å›¾æ ‡
function resetToDefaultIcon() {
    if (!currentEditingIcon) return;
    
    appIcons[currentEditingIcon] = null;
    saveToDB('appIcons', { id: 1, icons: appIcons });
    updateAllIcons();
    closeIconEditor();
}

// ä¿å­˜å›¾æ ‡
function saveAppIcon() {
    if (!currentEditingIcon) return;
    
    const fileInput = document.getElementById('iconFile');
    const urlInput = document.getElementById('iconUrl');
    
    if (fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            appIcons[currentEditingIcon] = e.target.result;
            saveToDB('appIcons', { id: 1, icons: appIcons });
            updateAllIcons();
            closeIconEditor();
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else if (urlInput.value) {
        appIcons[currentEditingIcon] = urlInput.value;
        saveToDB('appIcons', { id: 1, icons: appIcons });
        updateAllIcons();
        closeIconEditor();
    } else {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è¾“å…¥ç½‘å€');
    }
}

// å›¾æ ‡æ–‡ä»¶é¢„è§ˆ
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const checkbox = document.getElementById('cityInfoCheckbox');
        if (checkbox) {
            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œé˜²æ­¢é‡å¤ï¼‰ï¼Œè¿™é‡Œç›´æ¥è¦†ç›– onclick
            checkbox.onclick = function(e) {
                // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œè®©å‹¾é€‰æ¡†å…ˆå˜è‰²ï¼Œä½“éªŒæ›´å¥½
                if (this.checked) {
                    openCityInfoModal(); // å¼€å¯ -> å¼¹çª—
                } else {
                    if (confirm('ç¡®å®šå–æ¶ˆåŸå¸‚ä¿¡æ¯åŠŸèƒ½å—ï¼Ÿ')) {
                        disableCityInfo(); // å…³é—­ -> æ¸…é™¤æ•°æ®
                    } else {
                        this.checked = true; // åæ‚”äº† -> æ¢å¤å‹¾é€‰
                    }
                }
            };
        }
    }, 500);
});




// åŸå¸‚ä¿¡æ¯ç›¸å…³å˜é‡
let weatherData = {
    char: null,
    my: null,
    updateTime: null
};

// å¤é€‰æ¡†ç‚¹å‡»å¤„ç†
function handleCityInfoCheckbox() {
    const checkbox = document.getElementById('cityInfoCheckbox');
    
    if (checkbox.checked) {
        // å‹¾é€‰ï¼šæ‰“å¼€è®¾ç½®å¼¹çª—
        openCityInfoModal();
    } else {
        // å–æ¶ˆå‹¾é€‰ï¼šç¦ç”¨åŠŸèƒ½
        if (confirm('ç¡®å®šå–æ¶ˆåŸå¸‚ä¿¡æ¯åŠŸèƒ½å—ï¼Ÿ')) {
            disableCityInfo();
        } else {
            checkbox.checked = true;
        }
    }
}

// æ‰“å¼€åŸå¸‚ä¿¡æ¯è®¾ç½®å¼¹çª—
function openCityInfoModal() {
    if (!currentChatId) {
        alert('è¯·å…ˆæ‰“å¼€è§’è‰²ä¿¡æ¯é¡µé¢');
        const checkbox = document.getElementById('cityInfoCheckbox');
        if (checkbox) checkbox.checked = false;
        return;
    }
    
    loadFromDB('characterInfo', function(data) {
        const charData = data && data[currentChatId] ? data[currentChatId] : {};
        
        if (charData.charWeather && charData.myWeather) {
            weatherData = {
                char: charData.charWeather,
                my: charData.myWeather,
                updateTime: charData.weatherUpdateTime || getCurrentTime()
            };
        } else {
            weatherData = { char: null, my: null, updateTime: null };
        }
        
        document.getElementById('cityInfoModal').style.display = 'flex';
        
        const fields = {
            'charVirtualAddress': charData.charVirtualAddress || '',
            'charRealAddress': charData.charRealAddress || '',
            'myVirtualAddress': charData.myVirtualAddress || '',
            'myRealAddress': charData.myRealAddress || ''
        };
        
        for (let id in fields) {
            const el = document.getElementById(id);
            if (el) el.value = fields[id];
        }
        
        if (charData.charWeather && charData.myWeather) {
            displayWeatherPreview(charData);
        } else {
            const preview = document.getElementById('weatherPreview');
            if (preview) preview.style.display = 'none';
        }
    });
}





// å…³é—­å¼¹çª—
function closeCityInfoModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('cityInfoModal').style.display = 'none';
    
    // æ£€æŸ¥æ˜¯å¦å·²ä¿å­˜
    loadFromDB('characterInfo', (data) => {
        const charData = data && data[currentChatId] ? data[currentChatId] : {};
        const checkbox = document.getElementById('cityInfoCheckbox');
        if (checkbox && !charData.cityInfoEnabled) {
            checkbox.checked = false;
        }
    });
}

// è·å–å¤©æ°”æ•°æ®
async function fetchWeatherData() {
    const charCity = document.getElementById('charRealAddress').value.trim();
    const myCity = document.getElementById('myRealAddress').value.trim();
    
    if (!charCity || !myCity) {
        alert('è¯·å…ˆå¡«å†™å‚è€ƒåœ°å€');
        return;
    }
    
    const btn = event.target;
    
    try {
        btn.disabled = true;
        btn.textContent = 'æ­£åœ¨è·å–...';
        
        // å¹¶å‘è·å–å¤©æ°”
        const [charWeather, myWeather] = await Promise.all([
            searchCityWeather(charCity),
            searchCityWeather(myCity)
        ]);
        
        weatherData = {
            char: charWeather,
            my: myWeather,
            updateTime: getCurrentTime()
        };
        
        // æ˜¾ç¤ºé¢„è§ˆ
        displayWeatherPreview({
            charVirtualAddress: document.getElementById('charVirtualAddress').value || charCity,
            charRealAddress: charCity,
            charWeather: charWeather,
            myVirtualAddress: document.getElementById('myVirtualAddress').value || myCity,
            myRealAddress: myCity,
            myWeather: myWeather,
            weatherUpdateTime: weatherData.updateTime
        });
        
    } catch (error) {
        alert('è·å–å¤©æ°”å¤±è´¥ï¼š' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'è·å–åœ°å€ä¿¡æ¯';
    }
}

// æœç´¢åŸå¸‚å¤©æ°”ï¼ˆä½¿ç”¨OpenWeatherMapï¼‰
async function searchCityWeather(cityName) {
  
    // å°†ä½ çš„API keyå¡«åœ¨è¿™é‡Œ
    const apiKey = 'da8886b092269010824f1fcbc62e5115';
     // åŸå¸‚åç§°æ˜ å°„ï¼ˆä¸­æ–‡è½¬æ‹¼éŸ³ï¼‰
    const cityMap = {
        'åŒ—äº¬': 'Beijing',
        'ä¸Šæµ·': 'Shanghai',
        'å¹¿å·': 'Guangzhou',
        'æ·±åœ³': 'Shenzhen',
        'æ­å·': 'Hangzhou',
        'æˆéƒ½': 'Chengdu',
        'è¥¿å®‰': 'Xian',
        'æ­¦æ±‰': 'Wuhan',
        'å—äº¬': 'Nanjing',
        'é‡åº†': 'Chongqing'
    };
   // å¦‚æœæ˜¯ä¸­æ–‡åŸå¸‚åï¼Œè½¬æ¢ä¸ºæ‹¼éŸ³
    const searchCity = cityMap[cityName] || cityName;
    try {
        // è°ƒç”¨OpenWeatherMap 5å¤©é¢„æŠ¥APIï¼ˆåŒ…å«ä»Šå¤©å’Œæ˜å¤©ï¼‰
        const response = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(cityName)}&appid=${apiKey}&units=metric&lang=zh_cn`
        );
        
    if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`è·å–å¤©æ°”å¤±è´¥: ${errorData.message || response.status}`);
}

        
        const data = await response.json();
        
        // è·å–å½“å‰æ—¶é—´
        const now = new Date();
        const todayDate = now.toISOString().split('T')[0];
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowDate = tomorrow.toISOString().split('T')[0];
        
        // ç­›é€‰ä»Šå¤©å’Œæ˜å¤©çš„æ•°æ®
        const todayData = data.list.filter(item => 
            item.dt_txt.startsWith(todayDate)
        );
        const tomorrowData = data.list.filter(item => 
            item.dt_txt.startsWith(tomorrowDate)
        );
        
        // è®¡ç®—ä»Šå¤©çš„æ¸©åº¦èŒƒå›´
        let todayTemps = todayData.map(item => item.main.temp);
        if (todayTemps.length === 0) {
            todayTemps = [data.list[0].main.temp];
        }
        const todayMin = Math.round(Math.min(...todayTemps));
        const todayMax = Math.round(Math.max(...todayTemps));
        
        // è®¡ç®—æ˜å¤©çš„æ¸©åº¦èŒƒå›´
        let tomorrowTemps = tomorrowData.map(item => item.main.temp);
        if (tomorrowTemps.length === 0) {
            tomorrowTemps = [data.list[8].main.temp];
        }
        const tomorrowMin = Math.round(Math.min(...tomorrowTemps));
        const tomorrowMax = Math.round(Math.max(...tomorrowTemps));
        
        // è·å–å¤©æ°”æè¿°ï¼ˆå–ç¬¬ä¸€ä¸ªï¼‰
        const todayCondition = todayData.length > 0 
            ? todayData[0].weather[0].description 
            : data.list[0].weather[0].description;
        const tomorrowCondition = tomorrowData.length > 0 
            ? tomorrowData[0].weather[0].description 
            : data.list[8].weather[0].description;
        
        return {
            today: {
                condition: todayCondition,
                temp: `${todayMin}-${todayMax}Â°C`
            },
            tomorrow: {
                condition: tomorrowCondition,
                temp: `${tomorrowMin}-${tomorrowMax}Â°C`
            }
        };
        
    } catch (error) {
        console.error('è·å–å¤©æ°”å¤±è´¥ï¼š', error);
        throw new Error('æ— æ³•è·å–å¤©æ°”ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥åŸå¸‚åç§°');
    }
}


// æ˜¾ç¤ºå¤©æ°”é¢„è§ˆ
function displayWeatherPreview(data) {
    const preview = document.getElementById('weatherPreview');
    if (!preview) return;
    
    preview.innerHTML = `
        <div style="margin-bottom: 12px;">
            <strong>è§’è‰²åœ°åŒºï¼š${data.charVirtualAddress}ï¼ˆ${data.charRealAddress}ï¼‰</strong><br>
            ä»Šå¤©ï¼š${data.charWeather.today.condition} ${data.charWeather.today.temp}<br>
            æ˜å¤©ï¼š${data.charWeather.tomorrow.condition} ${data.charWeather.tomorrow.temp}
        </div>
        <div style="margin-bottom: 12px;">
            <strong>æˆ‘çš„åœ°åŒºï¼š${data.myVirtualAddress}ï¼ˆ${data.myRealAddress}ï¼‰</strong><br>
            ä»Šå¤©ï¼š${data.myWeather.today.condition} ${data.myWeather.today.temp}<br>
            æ˜å¤©ï¼š${data.myWeather.tomorrow.condition} ${data.myWeather.tomorrow.temp}
        </div>
        <div style="color: #999; font-size: 12px;">
            æœ€åæ›´æ–°ï¼š${data.weatherUpdateTime}
        </div>
    `;
    preview.style.display = 'block';
}

// ä¿å­˜åŸå¸‚ä¿¡æ¯
function saveCityInfo() {
    const charVirtual = document.getElementById('charVirtualAddress').value.trim();
    const charReal = document.getElementById('charRealAddress').value.trim();
    const myVirtual = document.getElementById('myVirtualAddress').value.trim();
    const myReal = document.getElementById('myRealAddress').value.trim();
    
    if (!charReal || !myReal) {
        alert('è¯·å¡«å†™å‚è€ƒåœ°å€');
        return;
    }
    
    function performSave() {
        loadFromDB('characterInfo', function(data) {
            const allCharData = data || {};
            const charData = allCharData[currentChatId] || {};
            
            charData.cityInfoEnabled = true;
            charData.lastWeatherDate = new Date().toISOString().split('T')[0];
            charData.weatherUpdateTime = weatherData.updateTime;
            
            charData.charVirtualAddress = charVirtual || charReal;
            charData.charRealAddress = charReal;
            charData.charWeather = weatherData.char;
            
            charData.myVirtualAddress = myVirtual || myReal;
            charData.myRealAddress = myReal;
            charData.myWeather = weatherData.my;
            
            allCharData[currentChatId] = charData;
            saveToDB('characterInfo', allCharData);
            
            alert('åŸå¸‚ä¿¡æ¯å·²ä¿å­˜');
            closeCityInfoModal();
            
            const checkbox = document.getElementById('cityInfoCheckbox');
            if (checkbox) checkbox.checked = true;
        });
    }
    
    if (!weatherData.char || !weatherData.my) {
        loadFromDB('characterInfo', function(data) {
            const charData = data && data[currentChatId] ? data[currentChatId] : {};
            
            if (charData.charWeather && charData.myWeather) {
                weatherData = {
                    char: charData.charWeather,
                    my: charData.myWeather,
                    updateTime: charData.weatherUpdateTime || getCurrentTime()
                };
                performSave();
            } else {
                alert('è¯·å…ˆè·å–å¤©æ°”ä¿¡æ¯');
            }
        });
        return;
    }
    
    performSave();
}



// ç¦ç”¨åŸå¸‚ä¿¡æ¯
function disableCityInfo() {
    loadFromDB('characterInfo', (data) => {
        const allCharData = data || {};
        const charData = allCharData[currentChatId] || {};
        
        charData.cityInfoEnabled = false;
        
        allCharData[currentChatId] = charData;
        saveToDB('characterInfo', allCharData);
    });
}
// æ£€æŸ¥å¹¶è‡ªåŠ¨æ›´æ–°å¤©æ°”
async function checkAndUpdateWeather(chatId) {
    loadFromDB('characterInfo', async (data) => {
        const charData = data && data[chatId] ? data[chatId] : {};
        
        // å¦‚æœæœªå¯ç”¨åŸå¸‚ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
        if (!charData.cityInfoEnabled) return;
        
        // è·å–ä»Šå¤©æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        
        // å¦‚æœæ—¥æœŸä¸åŒï¼Œè‡ªåŠ¨æ›´æ–°å¤©æ°”
        if (charData.lastWeatherDate !== today) {
            try {
                // å¹¶å‘è·å–å¤©æ°”
                const [charWeather, myWeather] = await Promise.all([
                    searchCityWeather(charData.charRealAddress),
                    searchCityWeather(charData.myRealAddress)
                ]);
                
                // æ›´æ–°æ•°æ®
                charData.lastWeatherDate = today;
                charData.weatherUpdateTime = getCurrentTime();
                charData.charWeather = charWeather;
                charData.myWeather = myWeather;
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                const allCharData = data || {};
                allCharData[chatId] = charData;
                saveToDB('characterInfo', allCharData);
                
                // æ˜¾ç¤ºåŒæ­¥æç¤º
                showWeatherSyncTip();
                
            } catch (error) {
                console.error('è‡ªåŠ¨æ›´æ–°å¤©æ°”å¤±è´¥ï¼š', error);
            }
        }
    });
}

// æ˜¾ç¤ºå¤©æ°”åŒæ­¥æç¤º
function showWeatherSyncTip() {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const tip = document.createElement('div');
    tip.className = 'weather-sync-tip';
    tip.textContent = 'âœ… ä»Šå¤©å¤©æ°”ä¿¡æ¯å·²åŒæ­¥';
    tip.style.cssText = `
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: #1dd1a1;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 1001;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        animation: fadeInOut 3s ease-in-out;
    `;
    
    // æ·»åŠ åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -10px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -10px); }
        }
    `;
    document.head.appendChild(style);
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(tip);
    
    // 3ç§’åç§»é™¤
    setTimeout(() => {
        tip.remove();
        style.remove();
    }, 3000);
}
// æ¸²æŸ“ä¸–ç•Œä¹¦é€‰æ‹©å™¨
function renderWorldbookSelector(selectedIds) {
    const container = document.getElementById('worldbookSelector');
    if (!container) return;
    
    // åŠ è½½æ‰€æœ‰ä¸–ç•Œä¹¦
    loadFromDB('worldbooks', (data) => {
        const allWorldbooks = data || [];
        
        if (allWorldbooks.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨ä¸–ç•Œä¹¦é¡µé¢æ·»åŠ </div>';
            return;
        }
        
        // æ¸²æŸ“å¤é€‰æ¡†åˆ—è¡¨
        container.innerHTML = allWorldbooks.map(wb => `
            <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                <input type="checkbox" 
                       id="wb-${wb.id}" 
                       value="${wb.id}" 
                       ${selectedIds.includes(wb.id) ? 'checked' : ''}
                       style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                <label for="wb-${wb.id}" style="flex: 1; cursor: pointer; font-size: 14px;">
                    <strong>${wb.title}</strong> 
                    <span style="color: #999; font-size: 12px;">(${wb.category})</span>
                </label>
            </div>
        `).join('');
    });
}

// è·å–é€‰ä¸­çš„ä¸–ç•Œä¹¦IDåˆ—è¡¨
function getSelectedWorldbooks() {
    const container = document.getElementById('worldbookSelector');
    if (!container) {
        console.log('worldbookSelectorä¸å­˜åœ¨');
        return [];
    }
    
    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    if (!checkboxes || checkboxes.length === 0) {
        console.log('æ²¡æœ‰é€‰ä¸­ä»»ä½•ä¸–ç•Œä¹¦');
        return [];
    }
    
    const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
 
    return ids;
}

// è·å–å…³è”ä¸–ç•Œä¹¦çš„å†…å®¹
async function getLinkedWorldbooksContent(linkedIds) {
    if (!linkedIds || linkedIds.length === 0) {
        return 'æ— ';
    }
    
    return new Promise((resolve) => {
        loadFromDB('worldbooks', (data) => {
            const allWorldbooks = data || [];
            const linkedBooks = allWorldbooks.filter(wb => linkedIds.includes(wb.id));
            
            if (linkedBooks.length === 0) {
                resolve('æ— ');
                return;
            }
            
            const content = linkedBooks.map(wb => 
                `ã€${wb.title}ã€‘\n${wb.content}`
            ).join('\n\n');
            
            resolve(content);
        });
    });
}
// å¯¼å‡ºèŠå¤©è®°å½•
function exportChatHistory() {
    if (!currentChatId) {
        alert('è¯·å…ˆæ‰“å¼€è§’è‰²ä¿¡æ¯é¡µé¢');
        return;
    }
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰æ¶ˆæ¯
    loadFromDB('messages', (data) => {
        const allData = data && data.list ? data.list : [];
        const chatMessages = allData.filter(m => m.chatId === currentChatId);
        
        if (chatMessages.length === 0) {
            alert('æš‚æ— èŠå¤©è®°å½•');
            return;
        }
        
        // æŒ‰æ—¶é—´æ­£åºæ’åº
        chatMessages.sort((a, b) => new Date(a.time) - new Date(b.time));
        
        // æ„å»ºå¯¼å‡ºå†…å®¹
        const now = new Date();
        const exportTime = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        
        let content = `=== ä¸${chat.name}çš„èŠå¤©è®°å½• ===\n`;
        content += `å¯¼å‡ºæ—¶é—´ï¼š${exportTime}\n\n`;
        
        // éå†æ¶ˆæ¯
        chatMessages.forEach(msg => {
            const timeStr = msg.time || '';
            const sender = msg.senderId === 'me' ? 'æˆ‘' : chat.name;
            
            // å¦‚æœæ˜¯æ’¤å›æ¶ˆæ¯
            if (msg.isRevoked) {
                content += `[${timeStr}] ${sender}: ${msg.content} [å·²æ’¤å›]\n`;
            } else {
                content += `[${timeStr}] ${sender}: ${msg.content}\n`;
            }
        });
        
        // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `èŠå¤©è®°å½•_${chat.name}_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.txt`;
        a.click();
        
        // é‡Šæ”¾URLå¯¹è±¡
        URL.revokeObjectURL(url);
        
        alert('èŠå¤©è®°å½•å·²å¯¼å‡º');
    });
}
// æ¸…é™¤èŠå¤©è®°å½•
function clearChatHistory() {
    if (!currentChatId) {
        alert('è¯·å…ˆæ‰“å¼€è§’è‰²ä¿¡æ¯é¡µé¢');
        return;
    }
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // äºŒæ¬¡ç¡®è®¤
    if (!confirm(`ç¡®å®šè¦æ¸…é™¤ä¸"${chat.name}"çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`)) {
        return;
    }
    
    // å†æ¬¡ç¡®è®¤ï¼ˆåŒé‡ä¿é™©ï¼‰
    if (!confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
        return;
    }
    
    // ä»æ•°æ®åº“åˆ é™¤å½“å‰è§’è‰²çš„æ‰€æœ‰æ¶ˆæ¯
    loadFromDB('messages', (data) => {
        const allData = data && data.list ? data.list : [];
        
        // è¿‡æ»¤æ‰å½“å‰è§’è‰²çš„æ¶ˆæ¯
        const remainingMessages = allData.filter(m => m.chatId !== currentChatId);
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        const transaction = db.transaction(['messages'], 'readwrite');
        const objectStore = transaction.objectStore('messages');
        objectStore.put({ id: 1, list: remainingMessages });
        
        // æ¸…ç©ºå†…å­˜ä¸­çš„æ¶ˆæ¯
        allMessages = [];
        visibleMessagesCount = 30;
        
        // æ›´æ–°èŠå¤©åˆ—è¡¨çš„æœ€åä¸€æ¡æ¶ˆæ¯
        chat.lastMessage = '';
        chat.lastMessageTime = getCurrentTime();
        chat.time = 'åˆšåˆš';
        saveToDB('chats', { list: chats });
        
        alert('èŠå¤©è®°å½•å·²æ¸…é™¤');
        
        // å¦‚æœå½“å‰åœ¨èŠå¤©è¯¦æƒ…é¡µï¼Œåˆ·æ–°æ˜¾ç¤º
        if (document.getElementById('chatDetailScreen').style.display === 'flex') {
            renderMessages();
        }
    });
}
// ============ æ—¥è®°åŠŸèƒ½ ============

// æ‰“å¼€æ—¥è®°åˆ—è¡¨
function openDiaryList() {
    if (!currentChatId) return;
    
    const chat = chats.find(c => c.id === currentChatId);
    if (!chat) return;
    
    // éšè—è§’è‰²ä¿¡æ¯é¡µï¼Œæ˜¾ç¤ºæ—¥è®°é¡µ
    document.getElementById('characterInfoScreen').style.display = 'none';
    document.getElementById('diaryScreen').style.display = 'flex';
    
    // è®¾ç½®æ ‡é¢˜
    document.getElementById('diaryOwnerName').textContent = `${chat.name}çš„æ—¥è®°`;
    
    // è®¾ç½®å†™æ—¥è®°çš„å¤´åƒå’Œåå­—
    const writingAvatar = document.getElementById('writingAvatar');
    if (chat.avatarImage) {
        writingAvatar.innerHTML = `<img src="${chat.avatarImage}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
    } else {
        writingAvatar.textContent = chat.avatar;
    }
    document.getElementById('writerName').textContent = chat.name;
    
    // åŠ è½½æ—¥è®°åˆ—è¡¨
    loadDiaries();
}

// è¿”å›è§’è‰²ä¿¡æ¯é¡µ
function backToCharacterInfo() {
    document.getElementById('diaryScreen').style.display = 'none';
    document.getElementById('characterInfoScreen').style.display = 'flex';
}

// åŠ è½½æ—¥è®°åˆ—è¡¨
function loadDiaries() {
    loadFromDB('diaries', (data) => {
        const allDiaries = data && data.list ? data.list : [];
        // ç­›é€‰å½“å‰è§’è‰²çš„æ—¥è®°
        diaries = allDiaries.filter(d => d.chatId === currentChatId);
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        diaries.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
        renderDiaryList();
    });
}

// æ¸²æŸ“æ—¥è®°åˆ—è¡¨
function renderDiaryList() {
    const container = document.getElementById('diaryListContainer');
    
    if (diaries.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #999; margin-top: 50px;">è¿˜æ²¡æœ‰æ—¥è®°å“¦~</div>';
        return;
    }
    
    container.innerHTML = diaries.map(diary => `
        <div class="diary-card" onclick="openDiaryDetail(${diary.id})">
            <div class="diary-title">${diary.title}</div>
            <div class="diary-time">${formatDiaryTime(diary.createTime)}</div>
            <div class="diary-preview">${getPreviewText(diary)}</div>
            <div class="diary-tags">
                ${diary.tags.map(tag => `<span class="diary-tag">#${tag}</span>`).join('')}
            </div>
        </div>
    `).join('');
}

// æ ¼å¼åŒ–æ—¥è®°æ—¶é—´
function formatDiaryTime(timeStr) {
    const time = new Date(timeStr);
    return `${time.getFullYear()}å¹´${time.getMonth() + 1}æœˆ${time.getDate()}æ—¥ ${String(time.getHours()).padStart(2, '0')}:${String(time.getMinutes()).padStart(2, '0')}`;
}

// è·å–é¢„è§ˆæ–‡æœ¬
function getPreviewText(diary) {
    let preview = '';
    if (diary.sections && diary.sections.length > 0) {
        const firstSection = diary.sections[0];
        if (firstSection.items && firstSection.items.length > 0) {
            preview = firstSection.items[0].text || '';
        } else if (firstSection.content) {
            preview = firstSection.content;
        }
    }
    return preview.substring(0, 100) + (preview.length > 100 ? '...' : '');
}

// å¬å”¤æ—¥è®°ï¼ˆç‚¹å‡»å¬å”¤å¡ç‰‡ï¼‰
function summonDiary() {
    // è§¦å‘æ˜Ÿæ˜Ÿç‰¹æ•ˆ
    triggerStarsEffect();
    
    // éšè—å¬å”¤å¡ç‰‡ï¼Œæ˜¾ç¤ºå†™æ—¥è®°çŠ¶æ€
    document.getElementById('summonCard').style.display = 'none';
    document.getElementById('writingCard').style.display = 'block';
    
    // è°ƒç”¨AIç”Ÿæˆæ—¥è®°
    setTimeout(() => {
        generateDiary();
    }, 300);
}

// æ˜Ÿæ˜Ÿç‰¹æ•ˆ
function triggerStarsEffect() {
    const container = document.getElementById('starsContainer');
    const emojis = ['âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âš¡'];
    
    // ç”Ÿæˆ5ä¸ªæ˜Ÿæ˜Ÿ
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            const star = document.createElement('div');
            star.className = 'star';
            star.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            
            // éšæœºæ–¹å‘
            const angle = Math.random() * 90 - 45;
            const distance = 50 + Math.random() * 30;
            const tx = Math.cos(angle * Math.PI / 180) * distance;
            const ty = Math.sin(angle * Math.PI / 180) * distance;
            
            star.style.setProperty('--tx', tx + 'px');
            star.style.setProperty('--ty', ty + 'px');
            
            container.appendChild(star);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => star.remove(), 600);
        }, i * 100);
    }
}

// AIç”Ÿæˆæ—¥è®°
async function generateDiary() {
    if (!currentChatId) return;
    
    // æ£€æŸ¥APIé…ç½®
    if (!currentApiConfig.baseUrl || !currentApiConfig.apiKey) {
        alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®');
        document.getElementById('writingCard').style.display = 'none';
        document.getElementById('summonCard').style.display = 'block';
        return;
    }
    
    const chat = chats.find(c => c.id === currentChatId);
    const characterInfo = await new Promise(resolve => {
        loadFromDB('characterInfo', data => {
            resolve(data && data[currentChatId] ? data[currentChatId] : {});
        });
    });
    
    const today = new Date();
    const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
    const timeStr = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;
    
    // æ„å»ºå¤©æ°”ä¿¡æ¯
    let weatherInfo = '';
    if (characterInfo.cityInfoEnabled && characterInfo.charWeather) {
        weatherInfo = `å½“å‰å¤©æ°”ï¼š${characterInfo.charWeather.today.condition}ï¼Œ${characterInfo.charWeather.today.temp}`;
    }
    
    const diaryPrompt = `ä½ æ˜¯${chat.name}ï¼Œç°åœ¨æ˜¯${dateStr} ${timeStr}ã€‚è¯·å†™ä¸€ç¯‡çœŸå®çš„ä¸ªäººæ—¥è®°ã€‚

ã€å¿…é¡»åŒ…å«ã€‘
- æ—¥è®°æ ‡é¢˜ï¼ˆç®€çŸ­æœ‰è¶£ï¼Œ10å­—ä»¥å†…ï¼‰
- ä»Šæ—¥å¤©æ°”ï¼ˆ${weatherInfo || 'æ ¹æ®å¿ƒæƒ…è™šæ„å¤©æ°”'}ï¼‰
- ä»Šæ—¥å¿ƒæƒ…ï¼ˆç”¨emoji + ç®€çŸ­æè¿°ï¼‰

ã€åŠ¨æ€æ¿å—ã€‘ä»ä»¥ä¸‹é€‰æ‹©4ä¸ªï¼ˆæ­£å¥½4ä¸ªï¼‰ï¼š
1. ä»Šæ—¥å¼€å¿ƒçš„äº‹æƒ…
2. çƒ¦æ¼æ¸…å•
3. æ‹çˆ±æ—¥è®°
4. å¤‡å¿˜å½•
5. è®°ä»‡æœ¬
6. TodoList
7. ç²¾ç¥çŠ¶æ€
8. åæ€å¤ç›˜

ã€ä»Šæ—¥æ„Ÿæ‚Ÿã€‘ï¼ˆå›ºå®šåœ¨æœ€åï¼Œå¿…é¡»å†™ï¼‰
- ä¸ä½äº300å­—
- éœ€è¦åˆ†æˆ3-4æ®µï¼Œæ¯æ®µå°‘äº120å­—
- æ¯æ®µå¼€å¤´ç©ºä¸¤æ ¼ï¼ˆé¦–è¡Œç¼©è¿›ï¼‰
- æ®µè½ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
- åƒçœŸäººä¸€æ ·æ·±å…¥æ€è€ƒå’Œæ€»ç»“

ã€å†™ä½œé£æ ¼ã€‘
- è‡ªç„¶çœŸå®ï¼Œå¯ä»¥æœ‰é”™åˆ«å­—ã€è¯­æ°”è¯
- å¯ä»¥åˆ’æ‰å†…å®¹é‡å†™ï¼šç”¨ ~~åˆ é™¤å†…å®¹~~ æ–°å†…å®¹
- TodoListç”¨ [x] å·²å®Œæˆï¼Œ[ ] æœªå®Œæˆ
- åŠ å…¥emojiè¡¨è¾¾æƒ…ç»ª
- ç¬¦åˆä½ çš„äººè®¾ï¼š${characterInfo.personality || 'ä¸€ä¸ªçœŸå®çš„äºº'}

ã€ä¸¥æ ¼æ ¼å¼ã€‘
æ ‡é¢˜: xxx
ä»Šæ—¥å¤©æ°”: xxx
ä»Šæ—¥å¿ƒæƒ…: xxx

[æ¿å—1åç§°]
1. xxx
2. ~~xxx~~ xxx
3. xxx

[æ¿å—2åç§°]
â€¢ [x] xxx
â€¢ [ ] xxx

[æ¿å—3åç§°]
xxx...

[æ¿å—4åç§°]
xxx...

[ä»Šæ—¥æ„Ÿæ‚Ÿ]
  ç¬¬ä¸€æ®µå†…å®¹...ï¼ˆä¸ä½äº80å­—ï¼‰

  ç¬¬äºŒæ®µå†…å®¹...ï¼ˆä¸ä½äº80å­—ï¼‰

  ç¬¬ä¸‰æ®µå†…å®¹...ï¼ˆä¸ä½äº80å­—ï¼‰

æ ‡ç­¾: #æ ‡ç­¾1 #æ ‡ç­¾2 #æ ‡ç­¾3

è¯·å¼€å§‹å†™æ—¥è®°ã€‚`;

    try {
        const url = currentApiConfig.baseUrl.endsWith('/') 
            ? currentApiConfig.baseUrl + 'chat/completions'
            : currentApiConfig.baseUrl + '/chat/completions';
            
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${currentApiConfig.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: currentApiConfig.defaultModel || 'gpt-3.5-turbo',
                messages: [{ role: 'user', content: diaryPrompt }],
                temperature: 0.9
            })
        });
        
        if (!response.ok) throw new Error('ç”Ÿæˆå¤±è´¥');
        
        const data = await response.json();
        const diaryContent = data.choices[0].message.content.trim();
        
        // è§£æå¹¶ä¿å­˜æ—¥è®°
        parseDiaryContent(diaryContent);
        
        // éšè—å†™æ—¥è®°çŠ¶æ€ï¼Œæ˜¾ç¤ºå¬å”¤å¡ç‰‡
        document.getElementById('writingCard').style.display = 'none';
        document.getElementById('summonCard').style.display = 'block';
        
        // åˆ·æ–°æ—¥è®°åˆ—è¡¨
        loadDiaries();
        
    } catch (error) {
        alert('ç”Ÿæˆæ—¥è®°å¤±è´¥ï¼š' + error.message);
        document.getElementById('writingCard').style.display = 'none';
        document.getElementById('summonCard').style.display = 'block';
    }
}

// è§£ææ—¥è®°å†…å®¹
function parseDiaryContent(content) {
    const lines = content.split('\n');
    const diary = {
        chatId: currentChatId,
        createTime: getCurrentTime(),
        title: '',
        weather: '',
        mood: '',
        sections: [],
        reflection: '',
        tags: []
    };
    
    let currentSection = null;
    let reflectionLines = [];
    let inReflection = false;
    
    for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        
        // è§£ææ ‡é¢˜
        if (line.startsWith('æ ‡é¢˜:') || line.startsWith('æ ‡é¢˜ï¼š')) {
            diary.title = line.replace(/æ ‡é¢˜[:ï¼š]\s*/, '');
        }
        // è§£æå¤©æ°”
        else if (line.startsWith('ä»Šæ—¥å¤©æ°”:') || line.startsWith('ä»Šæ—¥å¤©æ°”ï¼š')) {
            diary.weather = line.replace(/ä»Šæ—¥å¤©æ°”[:ï¼š]\s*/, '');
        }
        // è§£æå¿ƒæƒ…
        else if (line.startsWith('ä»Šæ—¥å¿ƒæƒ…:') || line.startsWith('ä»Šæ—¥å¿ƒæƒ…ï¼š')) {
            diary.mood = line.replace(/ä»Šæ—¥å¿ƒæƒ…[:ï¼š]\s*/, '');
        }
        // è§£ææ ‡ç­¾
        else if (line.startsWith('æ ‡ç­¾:') || line.startsWith('æ ‡ç­¾ï¼š')) {
            const tagsStr = line.replace(/æ ‡ç­¾[:ï¼š]\s*/, '');
            diary.tags = tagsStr.split(/\s+/).map(tag => tag.replace('#', '')).filter(t => t);
        }
        // è§£æä»Šæ—¥æ„Ÿæ‚Ÿ
        else if (line.startsWith('[ä»Šæ—¥æ„Ÿæ‚Ÿ]')) {
            inReflection = true;
            if (currentSection) {
                diary.sections.push(currentSection);
                currentSection = null;
            }
        }
        // å¦‚æœåœ¨ä»Šæ—¥æ„Ÿæ‚Ÿä¸­
        else if (inReflection) {
            reflectionLines.push(line);
        }
        // è§£ææ¿å—æ ‡é¢˜
        else if (line.startsWith('[') && line.endsWith(']')) {
            if (currentSection) {
                diary.sections.push(currentSection);
            }
            currentSection = {
                title: line.replace(/[\[\]]/g, ''),
                items: []
            };
        }
        // è§£ææ¿å—å†…å®¹
        else if (currentSection) {
            currentSection.items.push({ text: line });
        }
    }
    
    // ä¿å­˜æœ€åä¸€ä¸ªæ¿å—
    if (currentSection) {
        diary.sections.push(currentSection);
    }
    
    // å¤„ç†ä»Šæ—¥æ„Ÿæ‚Ÿ
    diary.reflection = reflectionLines.join('\n');
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    saveDiaryToDB(diary);
}

// ä¿å­˜æ—¥è®°åˆ°æ•°æ®åº“
function saveDiaryToDB(diary) {
    loadFromDB('diaries', (data) => {
        const allDiaries = data && data.list ? data.list : [];
        
        // ç”ŸæˆID
        const newId = allDiaries.length > 0 ? Math.max(...allDiaries.map(d => d.id || 0)) + 1 : 1;
        diary.id = newId;
        
        allDiaries.push(diary);
        
        const transaction = db.transaction(['diaries'], 'readwrite');
        const objectStore = transaction.objectStore('diaries');
        objectStore.put({ id: 1, list: allDiaries });
        
        // æ›´æ–°æ—¥è®°æ•°é‡æ˜¾ç¤º
        updateDiaryCount();
    });
}

// æ‰“å¼€æ—¥è®°è¯¦æƒ…
function openDiaryDetail(diaryId) {
    currentViewingDiaryId = diaryId;
    const diary = diaries.find(d => d.id === diaryId);
    if (!diary) return;
    
    // éšè—åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…
    document.getElementById('diaryScreen').style.display = 'none';
    document.getElementById('diaryDetailScreen').style.display = 'flex';
    
    // æ¸²æŸ“è¯¦æƒ…
    renderDiaryDetail(diary);
}

// æ¸²æŸ“æ—¥è®°è¯¦æƒ…
function renderDiaryDetail(diary) {
    const container = document.getElementById('diaryDetailContent');
    
    let html = `
        <div class="diary-detail-title">${diary.title}</div>
        <div class="diary-meta">
            ${formatDiaryTime(diary.createTime)}<br>
            ${diary.weather} | ${diary.mood}
        </div>
    `;
    
    // æ¸²æŸ“åŠ¨æ€æ¿å—
    diary.sections.forEach(section => {
        html += `
            <div class="diary-section">
                <div class="diary-section-title">${section.title}</div>
                <div class="diary-section-content">
                    ${section.items.map(item => {
                        let text = item.text;
                        // å¤„ç†åˆ é™¤çº¿
                        text = text.replace(/~~(.+?)~~/g, '<span class="strikethrough">$1</span>');
                        // å¤„ç†å¤é€‰æ¡†
                        text = text.replace(/\[x\]/gi, '<span class="checkbox-done">â˜‘</span>');
                        text = text.replace(/\[ \]/g, '<span class="checkbox-undone">â˜</span>');
                        return `<li>${text}</li>`;
                    }).join('')}
                </div>
            </div>
        `;
    });
    
    // æ¸²æŸ“ä»Šæ—¥æ„Ÿæ‚Ÿ
    if (diary.reflection) {
        html += `
            <div class="diary-section">
                <div class="diary-section-title">ä»Šæ—¥æ„Ÿæ‚Ÿ</div>
                <div class="diary-reflection">${diary.reflection}</div>
            </div>
        `;
    }
    
    // æ¸²æŸ“æ ‡ç­¾
    if (diary.tags && diary.tags.length > 0) {
        html += `
            <div class="diary-tags">
                ${diary.tags.map(tag => `<span class="diary-tag">#${tag}</span>`).join('')}
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// è¿”å›æ—¥è®°åˆ—è¡¨
function backToDiaryList() {
    document.getElementById('diaryDetailScreen').style.display = 'none';
    document.getElementById('diaryScreen').style.display = 'flex';
    currentViewingDiaryId = null;
}

// åˆ é™¤æ—¥è®°
function deleteDiary() {
    if (!currentViewingDiaryId) return;
    
    loadFromDB('diaries', (data) => {
        let allDiaries = data && data.list ? data.list : [];
        allDiaries = allDiaries.filter(d => d.id !== currentViewingDiaryId);
        
        const transaction = db.transaction(['diaries'], 'readwrite');
        const objectStore = transaction.objectStore('diaries');
        objectStore.put({ id: 1, list: allDiaries });
        
        // è¿”å›åˆ—è¡¨é¡µ
        backToDiaryList();
        loadDiaries();
        
        // æ›´æ–°æ—¥è®°æ•°é‡
        updateDiaryCount();
    });
}

// æ›´æ–°æ—¥è®°æ•°é‡æ˜¾ç¤º
function updateDiaryCount() {
    if (!currentChatId) return;
    
    loadFromDB('diaries', (data) => {
        const allDiaries = data && data.list ? data.list : [];
        const count = allDiaries.filter(d => d.chatId === currentChatId).length;
        
        const countEl = document.getElementById('charFollowers');
        if (countEl) {
            countEl.textContent = count;
        }
    });
}

        // åˆå§‹åŒ–
        initDB();
    </script>
</body>
</html>
